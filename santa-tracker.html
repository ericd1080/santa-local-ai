<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santa Tracker - FIXED VERSION ‚úÖ (Heart Bug Fixed)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Leaflet CSS and JS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <!-- Ensure all CDN dependencies are loaded before modules -->
    <script>
        // Wait for all external dependencies to load
        window.addEventListener('load', function() {
            console.log('üìö All external dependencies loaded');
        });

        // Suppress known development warnings for cleaner console
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');

            // Suppress Tailwind CSS production warning (expected in development)
            if (message.includes('cdn.tailwindcss.com should not be used in production')) {
                return;
            }

            // Suppress Babel transformer warning (expected in development)
            if (message.includes('You are using the in-browser Babel transformer')) {
                return;
            }

            // Allow all other warnings through
            originalWarn.apply(console, args);
        };
    </script>
    <style>
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes giftDrop {
            0% {
                transform: translateY(-100vh) rotate(0deg) scale(0.8);
                opacity: 0;
                filter: blur(2px);
            }
            10% {
                opacity: 1;
                filter: blur(0px);
                transform: translateY(-80vh) rotate(45deg) scale(1);
            }
            50% {
                transform: translateY(30vh) rotate(180deg) scale(1.1);
                opacity: 1;
            }
            70% {
                transform: translateY(70vh) rotate(270deg) scale(1);
                opacity: 1;
            }
            85% {
                transform: translateY(85vh) rotate(360deg) scale(0.9);
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(450deg) scale(0.7);
                opacity: 0;
            }
        }

        @keyframes giftBounce {
            0% {
                transform: translateY(0) scale(1);
            }
            15% {
                transform: translateY(-20px) scale(1.1);
            }
            30% {
                transform: translateY(0) scale(0.95);
            }
            45% {
                transform: translateY(-10px) scale(1.05);
            }
            60% {
                transform: translateY(0) scale(0.98);
            }
            75% {
                transform: translateY(-5px) scale(1.02);
            }
            90% {
                transform: translateY(0) scale(0.99);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        @keyframes giftSparkle {
            0%, 100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1) rotate(180deg);
                opacity: 1;
            }
        }

        @keyframes giftTrail {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(20px) scale(0.3);
                opacity: 0;
            }
        }

        @keyframes magicalShimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: 200px 0;
            }
        }

        .gift-drop {
            position: fixed;
            font-size: 2rem;
            animation: giftDrop 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
            z-index: 1000;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .gift-drop.special {
            animation: giftDrop 5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            font-size: 2.5rem;
            filter: drop-shadow(0 6px 12px rgba(255,215,0,0.4));
        }

        .gift-drop.user-targeted {
            animation: giftDrop 5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            font-size: 2.2rem;
            filter: drop-shadow(0 0 15px #ffd700) drop-shadow(0 0 25px #ffa500);
            z-index: 1000;
        }

        .gift-location-target {
            position: fixed;
            z-index: 999;
            font-size: 1.5rem;
            animation: targetPulse 0.8s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes targetPulse {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.3) rotate(10deg);
                opacity: 1;
                filter: drop-shadow(0 0 15px #ff6b6b);
            }
        }

        @keyframes slideDown {
            0% {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Santa Map Modal Styles */
        .santa-map-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .santa-map-container {
            width: 90vw;
            height: 80vh;
            max-width: 1200px;
            max-height: 800px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .santa-map {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        /* Santa Sleigh Animation */
        .santa-sleigh {
            position: absolute;
            z-index: 1000;
            font-size: 2rem;
            pointer-events: none;
            display: flex;
            align-items: center;
            animation: sleighFly 8s ease-in-out infinite;
        }

        .reindeer {
            font-size: 1.5rem;
            margin-right: 2px;
            animation: reindeerBounce 1s ease-in-out infinite;
        }

        .reindeer:nth-child(1) { animation-delay: 0s; }
        .reindeer:nth-child(2) { animation-delay: 0.1s; }
        .reindeer:nth-child(3) { animation-delay: 0.2s; }
        .reindeer:nth-child(4) { animation-delay: 0.3s; }

        .santa-icon {
            font-size: 2rem;
            margin-left: 5px;
            animation: santaBounce 1.2s ease-in-out infinite;
        }

        .sleigh-trail {
            position: absolute;
            font-size: 1rem;
            pointer-events: none;
            animation: trailSparkle 2s ease-out infinite;
            z-index: 999;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            gap: 10px;
        }

        .map-control-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
        }

        .map-control-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes sleighFly {
            0% { transform: translateX(-100px) translateY(20px) rotate(-5deg); }
            25% { transform: translateX(25%) translateY(-10px) rotate(2deg); }
            50% { transform: translateX(50%) translateY(15px) rotate(-2deg); }
            75% { transform: translateX(75%) translateY(-5px) rotate(1deg); }
            100% { transform: translateX(calc(100% + 100px)) translateY(25px) rotate(-3deg); }
        }

        @keyframes reindeerBounce {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-3px) rotate(2deg); }
        }

        @keyframes santaBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-2px) scale(1.05); }
        }

        @keyframes trailSparkle {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.3) rotate(180deg) translateX(-20px);
            }
        }

        /* Map Marker Styles */
        .santa-map-marker,
        .user-map-marker {
            font-size: 20px;
            text-align: center;
            line-height: 20px;
            animation: markerBounce 2s ease-in-out infinite;
        }

        .santa-map-marker {
            filter: drop-shadow(0 4px 8px rgba(220, 38, 38, 0.3));
        }

        .user-map-marker {
            filter: drop-shadow(0 4px 8px rgba(5, 150, 105, 0.3));
        }

        @keyframes markerBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.1); }
        }

        /* Responsive optimizations for gift drops */
        @media (max-width: 768px) {
            .gift-drop,
            .gift-drop.special,
            .gift-drop.user-targeted {
                font-size: 1.5rem; /* Smaller on mobile */
            }

            .gift-location-target {
                font-size: 1.2rem; /* Smaller targeting indicators on mobile */
            }

            .gift-sparkle {
                font-size: 0.8rem; /* Smaller sparkles on mobile */
            }

            .santa-map-container {
                width: 95vw;
                height: 85vh;
            }

            .santa-sleigh {
                font-size: 1.5rem;
            }

            .reindeer {
                font-size: 1.2rem;
            }

            .santa-icon {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .gift-drop,
            .gift-drop.special,
            .gift-drop.user-targeted {
                font-size: 1.2rem; /* Even smaller on very small screens */
            }

            .santa-map-container {
                width: 98vw;
                height: 90vh;
            }

            .map-controls {
                top: 10px;
                right: 10px;
            }

            .santa-sleigh {
                font-size: 1.2rem;
            }

            .reindeer {
                font-size: 1rem;
            }

            .santa-icon {
                font-size: 1.2rem;
            }
        }

        .gift-landed {
            position: fixed;
            font-size: 1.5rem;
            animation: giftBounce 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            z-index: 1000;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .gift-sparkle {
            position: fixed;
            font-size: 1rem;
            animation: giftSparkle 1s ease-in-out;
            pointer-events: none;
            z-index: 999;
            color: gold;
        }

        .gift-trail {
            position: fixed;
            font-size: 1rem;
            animation: giftTrail 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 998;
            opacity: 0.6;
        }

        .magical-shimmer {
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            background-size: 200px 100%;
            animation: magicalShimmer 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root">Loading Santa Tracker...</div>

    <!-- Load configuration scripts in order -->
    <script>
        // Placeholder for managers - will be set by individual scripts
        window.soundManager = null;
        window.languageManager = null;
        window.reindeerManager = null;
        window.weatherManager = null;
        window.chimneySafetyManager = null;
    </script>
    <script src="js/SoundManager.js"></script>
    <script src="js/LanguageManager.js"></script>
    <script src="js/ReindeerManager.js"></script>
    <script src="js/WeatherManager.js"></script>
    <script src="js/ChimneySafetyManager.js"></script>
    <script>
        // Managers are now available as global variables

        // Configuration Manager
        class ConfigManager {
            constructor() {
                this.config = null;
                this.listeners = [];
                this.configPath = './config/santa-config.json';
                this.isLoaded = false;
            }

            async load() {
                try {
                    const response = await fetch(this.configPath);
                    if (!response.ok) {
                        throw new Error(`Failed to load config: ${response.status}`);
                    }

                    this.config = await response.json();
                    this.isLoaded = true;

                    this.validateConfig();
                    this.notifyListeners('config-loaded', this.config);

                    console.log('‚úÖ Configuration loaded successfully');
                    return this.config;
                } catch (error) {
                    console.error('‚ùå Failed to load configuration:', error);
                    this.loadDefaultConfig();
                    throw error;
                }
            }

            loadDefaultConfig() {
                this.config = {
                    aiProvider: {
                        type: "ollama",
                        url: "http://localhost:11434",
                        defaultModel: "llama3.2",
                        availableModels: [
                            {
                                name: "llama3.2",
                                displayName: "Llama 3.2",
                                description: "Default model",
                                parameters: {
                                    temperature: 0.8,
                                    num_predict: 150
                                }
                            }
                        ]
                    },
                    prompts: {
                        preparing: "You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) about preparing for Christmas Eve at the North Pole. The elves are busy wrapping presents. Be jolly, mention the reindeer if relevant, and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks.",
                        delivering: "You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) to someone tracking your journey. Santa is currently delivering presents around the world! {{DISTANCE_CONTEXT}} {{GIFTS_CONTEXT}} Be jolly, mention the reindeer if relevant, and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks.",
                        finished: "You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) about finishing Christmas deliveries and resting at the North Pole with the reindeer. Be jolly and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks."
                    },
                    server: {
                        port: 8000,
                        corsEnabled: true
                    },
                    ui: {
                        showConfigPanel: true,
                        allowModelSwitching: true,
                        allowPromptEditing: true
                    },
                    features: {
                        modelValidation: true,
                        autoDiscoverModels: false,
                        configAutoSave: true
                    }
                };

                this.isLoaded = true;
                console.log('‚ö†Ô∏è Using default configuration as fallback');
            }

            validateConfig() {
                if (!this.config) {
                    throw new Error('Configuration is null or undefined');
                }

                const requiredSections = ['aiProvider', 'prompts', 'server'];
                for (const section of requiredSections) {
                    if (!this.config[section]) {
                        throw new Error(`Missing required configuration section: ${section}`);
                    }
                }

                console.log('‚úÖ Configuration validation passed');
            }

            get(path) {
                if (!this.isLoaded) {
                    throw new Error('Configuration not loaded. Call load() first.');
                }

                const keys = path.split('.');
                let value = this.config;

                for (const key of keys) {
                    if (value && typeof value === 'object' && key in value) {
                        value = value[key];
                    } else {
                        return undefined;
                    }
                }

                return value;
            }

            set(path, value) {
                if (!this.isLoaded) {
                    throw new Error('Configuration not loaded. Call load() first.');
                }

                const keys = path.split('.');
                const lastKey = keys.pop();
                let target = this.config;

                for (const key of keys) {
                    if (!target[key] || typeof target[key] !== 'object') {
                        target[key] = {};
                    }
                    target = target[key];
                }

                target[lastKey] = value;
                this.notifyListeners('config-changed', { path, value, config: this.config });

                if (this.get('features.configAutoSave')) {
                    this.save();
                }
            }

            getCurrentModel() {
                const defaultModel = this.get('aiProvider.defaultModel');
                const models = this.get('aiProvider.availableModels');
                return models.find(model => model.name === defaultModel);
            }

            setCurrentModel(modelName) {
                const models = this.get('aiProvider.availableModels');
                const modelExists = models.some(model => model.name === modelName);

                if (!modelExists) {
                    throw new Error(`Model '${modelName}' not found in available models`);
                }

                this.set('aiProvider.defaultModel', modelName);
                console.log(`‚úÖ Changed current model to: ${modelName}`);
            }

            getAvailableModels() {
                return this.get('aiProvider.availableModels') || [];
            }

            getPrompt(promptType) {
                return this.get(`prompts.${promptType}`);
            }

            setPrompt(promptType, promptText) {
                this.set(`prompts.${promptType}`, promptText);
                console.log(`‚úÖ Updated prompt: ${promptType}`);
            }

            addEventListener(event, callback) {
                this.listeners.push({ event, callback });
            }

            removeEventListener(event, callback) {
                this.listeners = this.listeners.filter(
                    listener => !(listener.event === event && listener.callback === callback)
                );
            }

            notifyListeners(event, data) {
                this.listeners
                    .filter(listener => listener.event === event)
                    .forEach(listener => {
                        try {
                            listener.callback(data);
                        } catch (error) {
                            console.error('Error in config listener:', error);
                        }
                    });
            }

            getSummary() {
                if (!this.isLoaded) {
                    return 'Configuration not loaded';
                }

                const currentModel = this.getCurrentModel();
                const modelCount = this.getAvailableModels().length;

                return {
                    isLoaded: this.isLoaded,
                    currentModel: currentModel?.name || 'none',
                    availableModels: modelCount,
                    provider: this.get('aiProvider.type'),
                    serverUrl: this.get('aiProvider.url'),
                    features: this.get('features')
                };
            }

            async save() {
                try {
                    console.log('üíæ Configuration would be saved (server endpoint needed)');
                } catch (error) {
                    console.error('‚ùå Failed to save configuration:', error);
                }
            }
        }

        // Prompt Manager
        class PromptManager {
            constructor(configManager) {
                this.configManager = configManager;
                this.templateCache = {};
                this.contextProviders = new Map();
                this.defaultContext = {};
            }

            generatePrompt(promptType, context = {}) {
                try {
                    // For Santa messages, use language-aware prompts
                    const santaMessageTypes = ['preparing', 'delivering', 'finished'];
                    if (santaMessageTypes.includes(promptType)) {
                        return this.generateLanguageAwareSantaPrompt(promptType, context);
                    }

                    const template = this.configManager.getPrompt(promptType);
                    if (!template) {
                        throw new Error(`Prompt template '${promptType}' not found`);
                    }

                    const fullContext = this.buildFullContext(context);
                    const prompt = this.interpolateTemplate(template, fullContext);

                    console.log(`‚úÖ Generated prompt for '${promptType}'`);
                    return prompt;

                } catch (error) {
                    console.error(`‚ùå Failed to generate prompt '${promptType}':`, error);
                    return this.getFallbackPrompt(promptType, context);
                }
            }

            generateLanguageAwareSantaPrompt(promptType, context = {}) {
                const currentLanguage = window.languageManager.getCurrentLanguage();
                const fullContext = this.buildFullContext(context);

                if (currentLanguage === 'ko') {
                    // Korean Santa prompts with EXAMPLES - Show don't tell approach
                    const koreanPrompts = {
                        preparing: `ÎãπÏã†ÏùÄ ÏÇ∞ÌÉÄÌÅ¥Î°úÏä§ÏûÖÎãàÎã§. ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î∏åÎ•º ÏúÑÌï¥ Î∂ÅÍ∑πÏóêÏÑú Ï§ÄÎπÑÌïòÍ≥† ÏûàÎäî ÏÉÅÌô©Ïóê ÎåÄÌï¥ Îî∞ÎúªÌïòÍ≥† Ï¶êÍ±∞Ïö¥ ÌïúÍµ≠Ïñ¥ Î©îÏãúÏßÄÎ•º 2-3Î¨∏Ïû•ÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.`,
                        delivering: `ÎãπÏã†ÏùÄ ÏÇ∞ÌÉÄÌÅ¥Î°úÏä§ÏûÖÎãàÎã§. ÏßÄÍ∏à Ï†ÑÏÑ∏Í≥ÑÏóê ÏÑ†Î¨ºÏùÑ Î∞∞Îã¨ÌïòÍ≥† ÏûàÎäî ÏÉÅÌô©Ïóê ÎåÄÌï¥ Îî∞ÎúªÌïòÍ≥† Ï¶êÍ±∞Ïö¥ ÌïúÍµ≠Ïñ¥ Î©îÏãúÏßÄÎ•º 2-3Î¨∏Ïû•ÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî. ${fullContext.DISTANCE_CONTEXT || ''} ${fullContext.GIFTS_CONTEXT || ''}`,
                        finished: `ÎãπÏã†ÏùÄ ÏÇ∞ÌÉÄÌÅ¥Î°úÏä§ÏûÖÎãàÎã§. ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÏÑ†Î¨º Î∞∞Îã¨ÏùÑ ÎßàÏπòÍ≥† ÏàúÎ°ùÎì§Í≥º Ìï®Íªò Î∂ÅÍ∑πÏóêÏÑú Ïâ¨Í≥† ÏûàÎäî ÏÉÅÌô©Ïóê ÎåÄÌï¥ Îî∞ÎúªÌïòÍ≥† Ï¶êÍ±∞Ïö¥ ÌïúÍµ≠Ïñ¥ Î©îÏãúÏßÄÎ•º 2-3Î¨∏Ïû•ÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.`
                    };
                    return koreanPrompts[promptType] || koreanPrompts.preparing;
                } else {
                    // English Santa prompts (existing)
                    const englishPrompts = {
                        preparing: "You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) about preparing for Christmas Eve at the North Pole. The elves are busy wrapping presents. Be jolly, mention the reindeer if relevant, and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks.",
                        delivering: `You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) to someone tracking your journey. Santa is currently delivering presents around the world! ${fullContext.DISTANCE_CONTEXT || ''} ${fullContext.GIFTS_CONTEXT || ''} Be jolly, mention the reindeer if relevant, and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks.`,
                        finished: "You are Santa Claus! Write a cheerful, warm message (2-3 sentences max) about finishing Christmas deliveries and resting at the North Pole with the reindeer. Be jolly and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks."
                    };
                    return englishPrompts[promptType] || englishPrompts.preparing;
                }
            }

            buildFullContext(userContext) {
                const context = { ...this.defaultContext, ...userContext };

                for (const [key, provider] of this.contextProviders) {
                    try {
                        if (typeof provider === 'function') {
                            context[key] = provider();
                        } else {
                            context[key] = provider;
                        }
                    } catch (error) {
                        console.warn(`Context provider '${key}' failed:`, error);
                    }
                }

                return context;
            }

            interpolateTemplate(template, context) {
                return template.replace(/\{\{([^}]+)\}\}/g, (match, variable) => {
                    const trimmedVar = variable.trim();
                    const value = this.getNestedProperty(context, trimmedVar);

                    if (value !== undefined && value !== null) {
                        return String(value);
                    } else {
                        console.warn(`Context variable '${trimmedVar}' not found, keeping placeholder`);
                        return match;
                    }
                });
            }

            getNestedProperty(obj, path) {
                return path.split('.').reduce((current, key) => {
                    return current && current[key] !== undefined ? current[key] : undefined;
                }, obj);
            }

            getSantaTimeContext() {
                const now = new Date();
                const christmasEve = new Date(now.getFullYear(), 11, 24, 18, 0, 0);
                const christmasDay = new Date(now.getFullYear(), 11, 25, 6, 0, 0);

                let phase = 'preparing';
                if (now >= christmasEve && now < christmasDay) {
                    phase = 'delivering';
                } else if (now >= christmasDay) {
                    phase = 'finished';
                }

                return {
                    phase,
                    isChristmasEve: now >= christmasEve && now < christmasDay,
                    isChristmasDay: now >= christmasDay,
                    isPreChristmas: now < christmasEve,
                    currentTime: now.toISOString(),
                    timeUntilChristmas: Math.max(0, christmasEve.getTime() - now.getTime()),
                    dayOfYear: Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000)
                };
            }

            buildSantaContext(santaStats, userLocation) {
                const timeContext = this.getSantaTimeContext();

                let distanceContext = '';
                let giftsContext = '';

                if (santaStats) {
                    if (santaStats.distance) {
                        distanceContext = `He is about ${santaStats.distance.toLocaleString()} km away from the user's location.`;
                    }

                    if (santaStats.giftsDelivered && santaStats.giftsDelivered > 0) {
                        giftsContext = `He has delivered ${santaStats.giftsDelivered.toLocaleString()} gifts so far!`;
                    }
                }

                return {
                    ...timeContext,
                    DISTANCE_CONTEXT: distanceContext,
                    GIFTS_CONTEXT: giftsContext,
                    USER_LOCATION: userLocation ? `${userLocation.lat.toFixed(2)}, ${userLocation.lon.toFixed(2)}` : 'unknown',
                    SANTA_STATUS: santaStats?.status || 'unknown'
                };
            }

            generateSantaMessage(santaStats, userLocation) {
                const context = this.buildSantaContext(santaStats, userLocation);
                const promptType = context.phase;

                return this.generatePrompt(promptType, context);
            }

            getFallbackPrompt(promptType, context) {
                const currentLanguage = window.languageManager.getCurrentLanguage();

                if (currentLanguage === 'ko') {
                    const koreanFallbacks = {
                        preparing: "Ìò∏Ìò∏Ìò∏! ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î∏åÎ•º ÏúÑÌï¥ Î∂ÅÍ∑πÏóêÏÑú Ïó¥Ïã¨Ìûà Ï§ÄÎπÑÌïòÍ≥† ÏûàÏñ¥Ïöî! ÏóòÌîÑÎì§Í≥º Ìï®Íªò Ïù¥Î≤à ÌÅ¨Î¶¨Ïä§ÎßàÏä§Î•º ÎßàÎ≤ïÍ∞ôÏù¥ ÎßåÎì§Í∏∞ ÏúÑÌï¥ ÎÖ∏Î†•ÌïòÍ≥† ÏûàÎãµÎãàÎã§! üéÖ",
                        delivering: "Ìò∏Ìò∏Ìò∏! Ï†Ñ ÏÑ∏Í≥ÑÎ•º ÎèåÏïÑÎã§ÎãàÎ©∞ ÏÑ†Î¨ºÏùÑ Î∞∞Îã¨ÌïòÍ≥† ÏûàÏñ¥Ïöî! Ï∞©ÌïòÍ≤å ÏßÄÎÇ¥Î©¥ Í≥ß ÎãπÏã†Ïùò ÏßÄÏó≠ÎèÑ Î∞©Î¨∏Ìï†ÏßÄÎèÑ Î™∞ÎùºÏöî! üéÅ",
                        finished: "Ìò∏Ìò∏Ìò∏! Ï†ïÎßê Î©ãÏßÑ ÌÅ¨Î¶¨Ïä§ÎßàÏä§ÏòÄÏñ¥Ïöî! Î™®Îì† ÏÑ†Î¨ºÏùÑ Î∞∞Îã¨ÌïòÍ≥† ÏàúÎ°ùÎì§Í≥º Ìï®Íªò ÏßëÏúºÎ°ú ÎèåÏïÑÏôîÎãµÎãàÎã§! üéÑ"
                    };
                    return koreanFallbacks[promptType] || "Ìò∏Ìò∏Ìò∏! ÏÇ∞ÌÉÄÍ∞Ä Ï†ÑÌïòÎäî Î©îÎ¶¨ ÌÅ¨Î¶¨Ïä§ÎßàÏä§! üéÖ";
                } else {
                    const englishFallbacks = {
                        preparing: "Ho ho ho! I'm busy preparing for Christmas Eve at the North Pole! The elves and I are working hard to make this Christmas magical! üéÖ",
                        delivering: "Ho ho ho! I'm on my way around the world delivering presents! Keep being good and I might visit your area soon! üéÅ",
                        finished: "Ho ho ho! What a wonderful Christmas that was! All the presents have been delivered and I'm back home with the reindeer! üéÑ"
                    };
                    return englishFallbacks[promptType] || "Ho ho ho! Merry Christmas from Santa! üéÖ";
                }
            }

            registerContextProvider(key, provider) {
                this.contextProviders.set(key, provider);
                console.log(`‚úÖ Registered context provider: ${key}`);
            }
        }

        // Create global instances
        const configManager = new ConfigManager();
        const promptManager = new PromptManager(configManager);

        // Register default context providers
        promptManager.registerContextProvider('timestamp', () => new Date().toISOString());
        promptManager.registerContextProvider('year', () => new Date().getFullYear());
        promptManager.registerContextProvider('santaTime', () => promptManager.getSantaTimeContext());

        // Auto-load configuration
        configManager.load().catch(error => {
            console.warn('Failed to auto-load configuration on startup:', error.message);
        });

        // Make available globally
        window.configManager = configManager;
        window.promptManager = promptManager;
        window.languageManager = languageManager;
        window.reindeerManager = reindeerManager;
        window.weatherManager = weatherManager;
        window.chimneySafetyManager = chimneySafetyManager;
    </script>

    <script type="text/babel">
        // Wait for all dependencies to be ready
        if (typeof React === 'undefined') {
            console.error('React is not loaded!');
        }
        if (typeof ReactDOM === 'undefined') {
            console.error('ReactDOM is not loaded!');
        }
        if (typeof lucide === 'undefined') {
            console.error('Lucide is not loaded!');
        }

        const { useState, useEffect, useRef } = React;
        // Removed problematic lucide destructuring - using emoji/text icons instead
        // const { Settings, AlertTriangle, MapPin, Clock, Gift, X, Globe, Heart, Trash2, Users, Cloud, CloudRain, Sun, Wind, Thermometer, Eye, Shield, CheckCircle, Home } = lucide || {};

        // Reindeer Panel component
        function ReindeerPanel({ isVisible, onClose, reindeerTeam, teamStatus }) {
            if (!isVisible) return null;

            const formation = window.reindeerManager.getReindeerFormation();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-red-600 to-green-600 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">ü¶å {window.languageManager.t('reindeer.panelTitle')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Team Status Overview */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-red-50 rounded-lg p-4 border border-red-200">
                                    <h3 className="font-semibold text-red-700 mb-2">{window.languageManager.t('reindeer.teamLeader')}</h3>
                                    <p className="text-2xl">{teamStatus.leader || 'Rudolph'}</p>
                                    <p className="text-sm text-gray-600">{window.languageManager.t('reindeer.leadingFormation')}</p>
                                </div>
                                <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                    <h3 className="font-semibold text-green-700 mb-2">{window.languageManager.t('reindeer.teamMorale')}</h3>
                                    <p className="text-2xl">{teamStatus.morale || 95}%</p>
                                    <p className="text-sm text-gray-600">{window.languageManager.t('reindeer.excellentSpirits')}</p>
                                </div>
                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <h3 className="font-semibold text-blue-700 mb-2">{window.languageManager.t('reindeer.formation')}</h3>
                                    <p className="text-2xl">{teamStatus.formation || 'V-Formation'}</p>
                                    <p className="text-sm text-gray-600">{window.languageManager.t('reindeer.optimalEfficiency')}</p>
                                </div>
                            </div>

                            {/* Special Status */}
                            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 mb-6 border border-yellow-200">
                                <h3 className="font-semibold text-orange-700 mb-2">üåü {window.languageManager.t('reindeer.currentStatus')}</h3>
                                <p className="text-gray-700">{teamStatus.specialStatus || window.languageManager.t('reindeer.teamStatusReady')}</p>
                            </div>

                            {/* Reindeer Formation Display */}
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold mb-4 text-center">üõ∑ {window.languageManager.t('reindeer.flightFormation')}</h3>
                                <div className="space-y-3">
                                    {formation.map((row, rowIndex) => (
                                        <div key={rowIndex} className="flex justify-center items-center space-x-4">
                                            {row.map((reindeer, colIndex) => (
                                                <div
                                                    key={`${rowIndex}-${colIndex}`}
                                                    className={`text-center p-3 rounded-lg border-2 min-w-[120px] ${
                                                        reindeer.name === 'Rudolph'
                                                            ? 'bg-red-100 border-red-300'
                                                            : 'bg-blue-100 border-blue-300'
                                                    }`}
                                                >
                                                    <div className="text-2xl mb-1">{reindeer.emoji}</div>
                                                    <div className="font-semibold text-sm">{reindeer.name}</div>
                                                    <div className="text-xs text-gray-600 capitalize">{reindeer.status}</div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Individual Reindeer Details */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {reindeerTeam.map(reindeer => (
                                    <div
                                        key={reindeer.name}
                                        className={`rounded-lg p-4 border-2 ${
                                            reindeer.name === 'Rudolph'
                                                ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300'
                                                : 'bg-gradient-to-br from-blue-50 to-blue-100 border-blue-300'
                                        }`}
                                    >
                                        <div className="flex items-center mb-3">
                                            <span className="text-2xl mr-3">{reindeer.emoji}</span>
                                            <div>
                                                <h4 className="font-bold text-lg">{reindeer.name}</h4>
                                                <p className="text-sm text-gray-600 capitalize">{reindeer.status}</p>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <div>
                                                <span className="text-xs font-medium text-gray-500">{window.languageManager.t('reindeer.personality')}</span>
                                                <p className="text-sm">{reindeer.personality}</p>
                                            </div>

                                            <div>
                                                <span className="text-xs font-medium text-gray-500">{window.languageManager.t('reindeer.specialty')}</span>
                                                <p className="text-sm">{reindeer.specialty}</p>
                                            </div>

                                            <div>
                                                <span className="text-xs font-medium text-gray-500">{window.languageManager.t('reindeer.currentTask')}</span>
                                                <p className="text-sm italic text-blue-700">{reindeer.currentTask}</p>
                                            </div>

                                            <div className="flex justify-between items-center">
                                                <span className="text-xs font-medium text-gray-500">{window.languageManager.t('reindeer.speed')}</span>
                                                <span className={`text-xs px-2 py-1 rounded-full ${
                                                    reindeer.speed === 'extremely fast' ? 'bg-red-200 text-red-800' :
                                                    reindeer.speed === 'very fast' ? 'bg-orange-200 text-orange-800' :
                                                    reindeer.speed === 'fast' ? 'bg-yellow-200 text-yellow-800' :
                                                    'bg-green-200 text-green-800'
                                                }`}>
                                                    {reindeer.speed}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-6 text-center">
                                <p className="text-sm text-gray-500">
                                    üéÑ {window.languageManager.t('reindeer.updateMessage')} ‚ú®
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Weather Panel component
        function WeatherPanel({ isVisible, onClose, currentWeather, weatherHistory, weatherForecast }) {
            if (!isVisible) return null;

            const getWeatherIcon = (type) => {
                const icons = {
                    'clear': <span style={{fontSize: '20px', color: '#eab308'}}>‚òÄÔ∏è</span>,
                    'cloudy': <span style={{fontSize: '20px', color: '#6b7280'}}>‚òÅÔ∏è</span>,
                    'rain': <span style={{fontSize: '20px', color: '#3b82f6'}}>üåßÔ∏è</span>,
                    'snow': '‚ùÑÔ∏è',
                    'blizzard': 'üå®Ô∏è',
                    'storm': '‚õàÔ∏è',
                    'fog': 'üå´Ô∏è',
                    'aurora': 'üåå',
                    'sandstorm': 'üå™Ô∏è',
                    'hot': 'üî•',
                    'windy': <span style={{fontSize: '20px', color: '#4b5563'}}>üí®</span>
                };
                return icons[type] || <span style={{fontSize: '20px'}}>‚òÅÔ∏è</span>;
            };

            const getDifficultyColor = (difficulty) => {
                switch (difficulty) {
                    case 'easy': return 'text-green-600 bg-green-100';
                    case 'moderate': return 'text-yellow-600 bg-yellow-100';
                    case 'challenging': return 'text-orange-600 bg-orange-100';
                    case 'very challenging': return 'text-red-600 bg-red-100';
                    default: return 'text-gray-600 bg-gray-100';
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">{window.languageManager.t('weather.panelTitle')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* Current Weather */}
                            {currentWeather && (
                                <div className="mb-6">
                                    <h3 className="text-lg font-semibold mb-4 text-center">{window.languageManager.t('weather.currentConditions')}</h3>
                                    <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6 border-2 border-blue-200">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.location')}</span>
                                                    <span className="text-blue-700 font-semibold">{currentWeather.location.area}</span>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.condition')}</span>
                                                    <div className="flex items-center space-x-2">
                                                        {getWeatherIcon(currentWeather.type)}
                                                        <span>{currentWeather.description}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.temperature')}</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span style={{fontSize: '16px'}}>üå°Ô∏è</span>
                                                        <span>{Math.round(currentWeather.temperature)}¬∞C</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.visibility')}</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span style={{fontSize: '16px'}}>üëÅÔ∏è</span>
                                                        <span className="capitalize">{currentWeather.visibility}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.windSpeed')}</span>
                                                    <div className="flex items-center space-x-2">
                                                        <span style={{fontSize: '16px'}}>üí®</span>
                                                        <span>{currentWeather.windSpeed} km/h</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.flightStatus')}</span>
                                                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${getDifficultyColor(currentWeather.difficulty)}`}>
                                                        {currentWeather.difficulty}
                                                    </span>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.reindeerMood')}</span>
                                                    <span className="capitalize text-green-600 font-medium">{currentWeather.reindeerMood}</span>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="font-medium text-gray-700">{window.languageManager.t('weather.localTime')}</span>
                                                    <span>{currentWeather.localTime}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {currentWeather.christmasMagic && (
                                            <div className="mt-4 p-3 bg-gradient-to-r from-yellow-100 to-red-100 rounded-lg border border-yellow-300">
                                                <p className="text-center text-yellow-800 font-medium">
                                                    ‚ú® {window.languageManager.t('weather.christmasMagicActive')}! ‚ú®
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Weather Forecast */}
                            {weatherForecast && weatherForecast.length > 0 && (
                                <div className="mb-6">
                                    <h3 className="text-lg font-semibold mb-4 text-center">{window.languageManager.t('weather.forecast')}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {weatherForecast.map((forecast, index) => (
                                            <div key={index} className="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg p-4 border border-green-200">
                                                <div className="text-center mb-3">
                                                    <h4 className="font-semibold text-gray-800">{forecast.location.area}</h4>
                                                    <p className="text-sm text-gray-600">{window.languageManager.t('weather.forecastIn', {hours: forecast.hoursAhead, plural: forecast.hoursAhead !== 1 ? 's' : ''})}</p>
                                                </div>
                                                <div className="space-y-2">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">{window.languageManager.t('weather.forecastWeather')}</span>
                                                        <div className="flex items-center space-x-1">
                                                            {getWeatherIcon(forecast.weather.type)}
                                                            <span className="text-sm">{forecast.weather.description}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">{window.languageManager.t('weather.forecastTemp')}</span>
                                                        <span className="text-sm">{Math.round(forecast.weather.temperature)}¬∞C</span>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm text-gray-700">{window.languageManager.t('weather.forecastDifficulty')}</span>
                                                        <span className={`px-2 py-1 rounded-full text-xs ${getDifficultyColor(forecast.weather.difficulty)}`}>
                                                            {forecast.weather.difficulty}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Weather History */}
                            {weatherHistory && weatherHistory.length > 0 && (
                                <div>
                                    <h3 className="text-lg font-semibold mb-4 text-center">{window.languageManager.t('weather.recentConditions')}</h3>
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {weatherHistory.slice(0, 5).map((weather, index) => (
                                            <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex items-center space-x-3">
                                                    {getWeatherIcon(weather.type)}
                                                    <div>
                                                        <p className="font-medium text-sm">{weather.location.area}</p>
                                                        <p className="text-xs text-gray-600">{weather.description}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-sm font-medium">{Math.round(weather.temperature)}¬∞C</p>
                                                    <p className="text-xs text-gray-500">
                                                        {new Date(weather.timestamp).toLocaleTimeString()}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="mt-6 text-center">
                                <p className="text-sm text-gray-500">
                                    üåç {window.languageManager.t('weather.updatesMessage')} üõ∑
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ChimneySafetyPanel component
        function ChimneySafetyPanel({ isVisible, onClose, currentTip, allTips, categories }) {
            if (!isVisible) return null;

            const [selectedCategory, setSelectedCategory] = useState('all');
            const [viewMode, setViewMode] = useState('tips'); // 'tips' or 'categories'

            const filteredTips = selectedCategory === 'all'
                ? allTips
                : allTips.filter(tip => tip.category === selectedCategory);

            const getSeverityColor = (severity) => {
                switch (severity) {
                    case 'critical': return 'bg-red-100 text-red-800 border-red-300';
                    case 'important': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
                    case 'helpful': return 'bg-blue-100 text-blue-800 border-blue-300';
                    default: return 'bg-gray-100 text-gray-800 border-gray-300';
                }
            };

            const getSeverityIcon = (severity) => {
                switch (severity) {
                    case 'critical': return 'üö®';
                    case 'important': return '‚ö†Ô∏è';
                    case 'helpful': return 'üí°';
                    default: return 'üí°';
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-red-600 to-green-600 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">{window.languageManager.t('safety.panelTitle')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[70vh]">
                            {/* View Mode Toggle */}
                            <div className="flex justify-center mb-6">
                                <div className="bg-gray-100 rounded-lg p-1 flex">
                                    <button
                                        onClick={() => setViewMode('tips')}
                                        className={`px-4 py-2 rounded-md font-medium transition-all ${
                                            viewMode === 'tips'
                                                ? 'bg-red-500 text-white'
                                                : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        {window.languageManager.t('safety.tabSafetyTips')}
                                    </button>
                                    <button
                                        onClick={() => setViewMode('categories')}
                                        className={`px-4 py-2 rounded-md font-medium transition-all ${
                                            viewMode === 'categories'
                                                ? 'bg-red-500 text-white'
                                                : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        {window.languageManager.t('safety.tabCategories')}
                                    </button>
                                </div>
                            </div>

                            {viewMode === 'categories' ? (
                                // Categories View
                                <div>
                                    <h3 className="text-lg font-semibold mb-4 text-center">{window.languageManager.t('safety.categoriesTitle')}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {categories.map((category) => (
                                            <div
                                                key={category.name}
                                                onClick={() => {
                                                    setSelectedCategory(category.name);
                                                    setViewMode('tips');
                                                }}
                                                className="bg-gradient-to-br from-red-50 to-green-50 rounded-xl p-4 border-2 border-red-200 cursor-pointer hover:border-red-400 transition-all transform hover:scale-105"
                                            >
                                                <div className="text-center">
                                                    <span className="text-3xl mb-2 block">{category.icon}</span>
                                                    <h4 className="font-bold text-gray-800 mb-1">{category.displayName}</h4>
                                                    <p className="text-sm text-gray-600">{category.tipCount} tip{category.tipCount !== 1 ? 's' : ''}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                // Tips View
                                <div>
                                    {/* Category Filter */}
                                    <div className="mb-6">
                                        <div className="flex flex-wrap gap-2 justify-center">
                                            <button
                                                onClick={() => setSelectedCategory('all')}
                                                className={`px-3 py-2 rounded-full text-sm font-medium transition-all ${
                                                    selectedCategory === 'all'
                                                        ? 'bg-red-500 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {window.languageManager.t('safety.allTips', {count: allTips.length})}
                                            </button>
                                            {categories.map((category) => (
                                                <button
                                                    key={category.name}
                                                    onClick={() => setSelectedCategory(category.name)}
                                                    className={`px-3 py-2 rounded-full text-sm font-medium transition-all ${
                                                        selectedCategory === category.name
                                                            ? 'bg-red-500 text-white'
                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {category.icon} {category.displayName} ({category.tipCount})
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Current Tip Highlight */}
                                    {currentTip && selectedCategory === 'all' && (
                                        <div className="mb-6">
                                            <h3 className="text-lg font-semibold mb-4 text-center">{window.languageManager.t('safety.featuredTip')}</h3>
                                            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 border-2 border-yellow-300">
                                                <div className="flex items-start space-x-4">
                                                    <span className="text-3xl">{currentTip.icon}</span>
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <h4 className="font-bold text-lg text-gray-800">{currentTip.title}</h4>
                                                            <span className={`px-3 py-1 rounded-full text-xs font-medium border ${getSeverityColor(currentTip.severity)}`}>
                                                                {getSeverityIcon(currentTip.severity)} {currentTip.severity}
                                                            </span>
                                                        </div>
                                                        <p className="text-gray-700 mb-3">{currentTip.tip}</p>
                                                        <div className="bg-white rounded-lg p-3 border border-yellow-200">
                                                            <p className="text-red-700 italic">üéÖ "{currentTip.santaQuote}"</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Tips List */}
                                    <div className="space-y-4">
                                        <h3 className="text-lg font-semibold text-center">
                                            {selectedCategory === 'all' ? window.languageManager.t('safety.allTipsHeader') : `${categories.find(c => c.name === selectedCategory)?.icon} ${categories.find(c => c.name === selectedCategory)?.displayName}`}
                                        </h3>
                                        {filteredTips.map((tip) => (
                                            <div
                                                key={tip.id}
                                                className={`rounded-xl p-4 border-2 ${
                                                    tip.id === currentTip?.id
                                                        ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-300'
                                                        : 'bg-gradient-to-br from-red-50 to-green-50 border-red-200'
                                                }`}
                                            >
                                                <div className="flex items-start space-x-3">
                                                    <span className="text-2xl">{tip.icon}</span>
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <h4 className="font-semibold text-gray-800">{tip.title}</h4>
                                                            <span className={`px-2 py-1 rounded-full text-xs font-medium border ${getSeverityColor(tip.severity)}`}>
                                                                {getSeverityIcon(tip.severity)} {tip.severity}
                                                            </span>
                                                        </div>
                                                        <p className="text-gray-700 text-sm mb-2">{tip.tip}</p>
                                                        <div className="bg-white bg-opacity-70 rounded-lg p-2 border border-red-100">
                                                            <p className="text-red-600 text-xs italic">üéÖ "{tip.santaQuote}"</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="mt-6 text-center">
                                <p className="text-sm text-gray-500">
                                    {window.languageManager.t('safety.updateMessage')}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Favorites Manager component
        function FavoritesManager({ isVisible, onClose, favorites, onRemove, currentLanguage }) {
            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-pink-600 to-red-600 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">‚≠ê {window.languageManager.t('favorites.panelTitle')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[60vh]">
                            {favorites.length === 0 ? (
                                <div className="text-center py-8">
                                    <span style={{fontSize: '48px', color: '#d1d5db', display: 'block', textAlign: 'center', marginBottom: '16px'}}>üíù</span>
                                    <p className="text-gray-500 mb-2">{window.languageManager.t('favorites.noMessages')}</p>
                                    <p className="text-sm text-gray-400">
                                        {window.languageManager.t('favorites.instructions')}
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {favorites.map((favorite) => (
                                        <div
                                            key={favorite.id}
                                            className="bg-gradient-to-br from-red-50 to-green-50 rounded-xl p-4 border-2 border-red-200"
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-lg">üéÖ</span>
                                                    <div className="text-xs text-gray-500">
                                                        {new Date(favorite.timestamp).toLocaleDateString()} ‚Ä¢
                                                        {favorite.language === 'ko' ? ' ÌïúÍµ≠Ïñ¥' : ' English'}
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => onRemove(favorite.id)}
                                                    className="text-red-500 hover:text-red-700 transition-colors p-1 rounded-full hover:bg-red-100"
                                                    title="Remove from favorites"
                                                >
                                                    <span style={{fontSize: '16px'}}>üóëÔ∏è</span>
                                                </button>
                                            </div>
                                            <p className="text-gray-700 leading-relaxed italic">
                                                "{favorite.message}"
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {favorites.length > 0 && (
                                <div className="mt-6 text-center">
                                    <p className="text-xs text-gray-500">
                                        {window.languageManager.t('favorites.messageCount', {
                                            count: favorites.length,
                                            plural: favorites.length !== 1 ? 's' : ''
                                        })} ‚Ä¢ {window.languageManager.t('favorites.maxMessages')}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Naughty List Manager component
        function NaughtyListManager({ isVisible, onClose, naughtyList, onAdd, onRemove, currentLanguage, newName, setNewName }) {
            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-red-600 to-red-800 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">
                                üìã {currentLanguage === 'ko' ? 'ÏÇ∞ÌÉÄÏùò ÎßêÏçΩÍæ∏Îü¨Í∏∞ Î™©Î°ù Í¥ÄÎ¶¨' : "Santa's Naughty List Manager"}
                            </h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        {/* Add New Name Section */}
                        <div className="bg-gray-50 p-4 border-b">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={newName}
                                    onChange={(e) => setNewName(e.target.value)}
                                    placeholder={currentLanguage === 'ko' ? 'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...' : 'Enter name...'}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                                    onKeyPress={(e) => e.key === 'Enter' && onAdd(newName)}
                                />
                                <button
                                    onClick={() => onAdd(newName)}
                                    disabled={!newName.trim()}
                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {currentLanguage === 'ko' ? 'Ï∂îÍ∞Ä' : 'Add'}
                                </button>
                            </div>
                            <p className="text-sm text-gray-600 mt-2">
                                {currentLanguage === 'ko'
                                    ? 'ÎßêÏçΩÍæ∏Îü¨Í∏∞ Î™©Î°ùÏóê Ïù¥Î¶ÑÏùÑ Ï∂îÍ∞ÄÌïòÎ©¥ Ìï≠ÏÉÅ "ÎßêÏçΩÍæ∏Îü¨Í∏∞"Î°ú ÌëúÏãúÎê©ÎãàÎã§.'
                                    : 'Names added to the naughty list will always be marked as "NAUGHTY".'}
                            </p>
                        </div>

                        <div className="p-6 overflow-y-auto max-h-[50vh]">
                            {naughtyList.length === 0 ? (
                                <div className="text-center py-8">
                                    <span style={{fontSize: '48px', color: '#d1d5db', display: 'block', textAlign: 'center', marginBottom: '16px'}}>üòá</span>
                                    <p className="text-gray-500 mb-2">
                                        {currentLanguage === 'ko' ? 'ÎßêÏçΩÍæ∏Îü¨Í∏∞ Î™©Î°ùÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§!' : 'No names on the naughty list!'}
                                    </p>
                                    <p className="text-sm text-gray-400">
                                        {currentLanguage === 'ko'
                                            ? 'Î™®Îì† ÏÇ¨ÎûåÏù¥ Ï∞©ÌïòÍ≤å ÌñâÎèôÌïòÍ≥† ÏûàÎÑ§Ïöî! üéÑ'
                                            : 'Everyone is being good! üéÑ'}
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {naughtyList.map((entry) => (
                                        <div
                                            key={entry.id}
                                            className="bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-4 border-2 border-red-200"
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-lg">üòà</span>
                                                    <div>
                                                        <h3 className="font-bold text-gray-800">{entry.name}</h3>
                                                        <div className="text-xs text-gray-500">
                                                            {currentLanguage === 'ko' ? 'Ï∂îÍ∞ÄÎê®: ' : 'Added: '}
                                                            {new Date(entry.addedAt).toLocaleDateString()}
                                                        </div>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => onRemove(entry.id)}
                                                    className="text-red-500 hover:text-red-700 transition-colors p-1 rounded-full hover:bg-red-100"
                                                    title={currentLanguage === 'ko' ? 'Î™©Î°ùÏóêÏÑú Ï†úÍ±∞' : 'Remove from list'}
                                                >
                                                    <span style={{fontSize: '16px'}}>üóëÔ∏è</span>
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600 italic">
                                                {currentLanguage === 'ko'
                                                    ? 'Ïù¥ Ïù¥Î¶ÑÏùÄ Ìï≠ÏÉÅ ÎßêÏçΩÍæ∏Îü¨Í∏∞Î°ú ÌëúÏãúÎê©ÎãàÎã§.'
                                                    : 'This name will always be marked as naughty.'}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {naughtyList.length > 0 && (
                                <div className="mt-6 text-center">
                                    <p className="text-xs text-gray-500">
                                        {naughtyList.length} {currentLanguage === 'ko' ? 'Î™ÖÏù¥ Î™©Î°ùÏóê ÏûàÏäµÎãàÎã§' : 'names on the list'} ‚Ä¢
                                        {currentLanguage === 'ko' ? ' Ï∞©ÌïòÍ≤å ÌñâÎèôÌïòÎ©¥ ÏÑ†Î¨ºÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî!' : ' Be good to get presents!'}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Language Selector component
        function LanguageSelector({ isVisible, onClose, currentLanguage, onLanguageChange }) {
            if (!isVisible) return null;

            const languages = window.languageManager.getSupportedLanguages();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full">
                        <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">üåê {window.languageManager.t('config.title')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6">
                            <p className="text-gray-600 mb-4">
                                Choose your language / Ïñ∏Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                            </p>

                            <div className="space-y-2">
                                {languages.map(lang => (
                                    <button
                                        key={lang.code}
                                        onClick={() => {
                                            window.languageManager.setLanguage(lang.code);
                                            onLanguageChange(lang.code);
                                            onClose(false);
                                        }}
                                        className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                                            currentLanguage === lang.code
                                                ? 'border-blue-500 bg-blue-50 text-blue-700'
                                                : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'
                                        }`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="font-medium">{lang.nativeName}</div>
                                                <div className="text-sm text-gray-500">{lang.name}</div>
                                            </div>
                                            {currentLanguage === lang.code && (
                                                <span className="text-blue-500 text-xl">‚úì</span>
                                            )}
                                        </div>
                                    </button>
                                ))}
                            </div>

                            <div className="mt-4 text-center">
                                <p className="text-xs text-gray-500">
                                    More languages coming soon! üéÑ
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Nice List Checker component
        function NiceListChecker({ isVisible, onClose, niceListName, setNiceListName, niceListResult, checkingNiceList, onCheck }) {
            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div className="bg-gradient-to-r from-red-600 to-green-600 text-white p-6 flex items-center justify-between rounded-t-xl">
                            <h2 className="text-xl font-bold">{window.languageManager.t('niceList.title')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="text-white hover:text-gray-200 transition-colors"
                            >
                                <span style={{fontSize: '24px'}}>‚ùå</span>
                            </button>
                        </div>

                        <div className="p-6">
                            <p className="text-gray-600 mb-4">
                                {window.languageManager.t('niceList.description')}
                            </p>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        {window.languageManager.t('niceList.nameLabel')}
                                    </label>
                                    <input
                                        type="text"
                                        value={niceListName}
                                        onChange={(e) => setNiceListName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && onCheck()}
                                        placeholder={window.languageManager.t('niceList.namePlaceholder')}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                        disabled={checkingNiceList}
                                    />
                                </div>

                                <button
                                    onClick={onCheck}
                                    disabled={!niceListName.trim() || checkingNiceList}
                                    className="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                >
                                    {checkingNiceList ? window.languageManager.t('niceList.checking') : window.languageManager.t('niceList.checkButton')}
                                </button>

                                {niceListResult && (
                                    <div className={`mt-4 p-4 rounded-lg border-2 ${
                                        niceListResult.status === 'NICE'
                                            ? 'bg-green-50 border-green-300'
                                            : 'bg-yellow-50 border-yellow-300'
                                    }`}>
                                        <div className="flex items-center mb-2">
                                            <span className="text-2xl mr-2">
                                                {niceListResult.status === 'NICE' ? '‚úÖ' : '‚ö†Ô∏è'}
                                            </span>
                                            <h3 className={`font-bold ${
                                                niceListResult.status === 'NICE' ? 'text-green-700' : 'text-yellow-700'
                                            }`}>
                                                {niceListResult.status === 'NICE' ? window.languageManager.t('niceList.onNiceList') : window.languageManager.t('niceList.onNaughtyList')}
                                            </h3>
                                        </div>
                                        <p className={`text-sm ${
                                            niceListResult.status === 'NICE' ? 'text-green-600' : 'text-yellow-600'
                                        }`}>
                                            {niceListResult.message}
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div className="mt-4 text-center">
                                <p className="text-xs text-gray-500">
                                    {window.languageManager.t('niceList.disclaimer')}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Simple ConfigPanel component for basic functionality
        function SimpleConfigPanel({ isVisible, onClose, currentModel, availableModels, onModelChange }) {
            if (!isVisible) {
                return (
                    <button
                        onClick={() => onClose(false)}
                        className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white p-3 rounded-full shadow-lg transition-all transform hover:scale-105"
                        title={window.languageManager.t('config.settingsNotAvailable')}
                    >
                        <span style={{fontSize: '24px'}}>‚öôÔ∏è</span>
                    </button>
                );
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div className="bg-red-600 text-white p-6 flex items-center justify-between">
                            <h2 className="text-xl font-bold">{window.languageManager.t('config.title')}</h2>
                            <button
                                onClick={() => onClose(false)}
                                className="hover:bg-red-700 p-2 rounded-lg"
                            >
                                ‚úï
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="mb-4">
                                <h3 className="text-lg font-semibold mb-2">{window.languageManager.t('config.currentModel')}</h3>
                                <p className="text-gray-600">{currentModel}</p>
                            </div>

                            <div className="mb-4">
                                <h3 className="text-lg font-semibold mb-2">{window.languageManager.t('config.availableModels')}</h3>
                                <div className="space-y-2">
                                    {availableModels.map((model) => (
                                        <div
                                            key={model.name}
                                            className={`border rounded-lg p-3 cursor-pointer ${
                                                currentModel === model.displayName || currentModel === model.name
                                                    ? 'border-red-500 bg-red-50'
                                                    : 'border-gray-200 hover:border-gray-300'
                                            }`}
                                            onClick={() => onModelChange(model.name)}
                                        >
                                            <div className="font-semibold">{model.displayName || model.name}</div>
                                            <div className="text-sm text-gray-600">{model.description || window.languageManager.t('config.modelDescription')}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="text-sm text-gray-500">
                                <p>{window.languageManager.t('config.enhancedServerNote')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Santa Map Modal Component
        function SantaMapModal({ isVisible, onClose, santaStats, userLocation }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const santaMarker = useRef(null);
            const userMarker = useRef(null);
            const sleighAnimation = useRef(null);

            useEffect(() => {
                if (isVisible && santaStats && !mapInstance.current) {
                    // Initialize map with performance optimizations
                    const map = L.map(mapRef.current, {
                        zoomControl: true,
                        scrollWheelZoom: true,
                        doubleClickZoom: true,
                        touchZoom: true,
                        dragging: true,
                        preferCanvas: true, // Better performance
                        attributionControl: false // We'll add it manually
                    }).setView([santaStats.santaLat, santaStats.santaLon], 4);

                    // Add OpenStreetMap tiles with performance settings
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 18,
                        minZoom: 2,
                        attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                        updateWhenIdle: true, // Better performance on mobile
                        keepBuffer: 2, // Reduce memory usage
                        maxNativeZoom: 18
                    }).addTo(map);

                    // Add attribution control
                    L.control.attribution({position: 'bottomright', prefix: false}).addTo(map);

                    mapInstance.current = map;
                }

                if (isVisible && mapInstance.current && santaStats) {
                    updateMapMarkers();
                    startSleighAnimation();
                }

                return () => {
                    if (sleighAnimation.current) {
                        clearInterval(sleighAnimation.current);
                    }
                };
            }, [isVisible, santaStats, userLocation]);

            const updateMapMarkers = () => {
                if (!mapInstance.current || !santaStats) return;

                const map = mapInstance.current;

                // Remove existing markers
                if (santaMarker.current) {
                    map.removeLayer(santaMarker.current);
                }
                if (userMarker.current) {
                    map.removeLayer(userMarker.current);
                }

                // Create custom Santa icon
                const santaIcon = L.divIcon({
                    html: '<div class="santa-map-marker">üéÖ</div>',
                    className: 'custom-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                // Add Santa marker
                santaMarker.current = L.marker([santaStats.santaLat, santaStats.santaLon], {
                    icon: santaIcon
                }).addTo(map)
                .bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="margin: 0 0 8px 0; color: #dc2626;">üéÖ Santa's Location</h3>
                        <p style="margin: 4px 0; font-size: 14px;"><strong>Status:</strong> ${santaStats.status}</p>
                        <p style="margin: 4px 0; font-size: 14px;"><strong>Coordinates:</strong> ${santaStats.santaLat.toFixed(2)}, ${santaStats.santaLon.toFixed(2)}</p>
                        ${santaStats.giftsDelivered > 0 ? `<p style="margin: 4px 0; font-size: 14px;"><strong>Gifts Delivered:</strong> ${santaStats.giftsDelivered.toLocaleString()}</p>` : ''}
                    </div>
                `, {
                    maxWidth: 250
                });

                // Add user marker if location is available
                if (userLocation) {
                    const userIcon = L.divIcon({
                        html: '<div class="user-map-marker">üìç</div>',
                        className: 'custom-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    userMarker.current = L.marker([userLocation.lat, userLocation.lon], {
                        icon: userIcon
                    }).addTo(map)
                    .bindPopup(`
                        <div style="text-align: center; padding: 10px;">
                            <h3 style="margin: 0 0 8px 0; color: #059669;">üìç Your Location</h3>
                            <p style="margin: 4px 0; font-size: 14px;"><strong>Coordinates:</strong> ${userLocation.lat.toFixed(2)}, ${userLocation.lon.toFixed(2)}</p>
                            ${santaStats.distance ? `<p style="margin: 4px 0; font-size: 14px;"><strong>Distance to Santa:</strong> ${santaStats.distance.toLocaleString()} km</p>` : ''}
                        </div>
                    `, {
                        maxWidth: 250
                    });
                }

                // Adjust view to show both markers
                if (userLocation && santaStats.distance !== undefined) {
                    const group = L.featureGroup([santaMarker.current, userMarker.current]);
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    map.setView([santaStats.santaLat, santaStats.santaLon], 4);
                }
            };

            const startSleighAnimation = () => {
                if (sleighAnimation.current) {
                    clearInterval(sleighAnimation.current);
                }

                const createSleighElement = () => {
                    const mapContainer = mapRef.current;
                    if (!mapContainer) return;

                    const sleigh = document.createElement('div');
                    sleigh.className = 'santa-sleigh';
                    sleigh.innerHTML = `
                        <span class="reindeer">ü¶å</span>
                        <span class="reindeer">ü¶å</span>
                        <span class="reindeer">ü¶å</span>
                        <span class="reindeer">ü¶å</span>
                        <span class="santa-icon">üõ∑</span>
                    `;

                    mapContainer.appendChild(sleigh);

                    let trailCount = 0;
                    const maxTrails = 15; // Limit trails for performance

                    // Create trail effect with performance limits
                    const createTrail = () => {
                        if (trailCount >= maxTrails) return;

                        trailCount++;
                        const trail = document.createElement('div');
                        trail.className = 'sleigh-trail';
                        trail.innerHTML = '‚ú®';
                        trail.style.left = Math.random() * 30 + 35 + '%'; // Center area
                        trail.style.top = Math.random() * 20 + 40 + '%';
                        mapContainer.appendChild(trail);

                        setTimeout(() => {
                            if (trail.parentNode) {
                                trail.parentNode.removeChild(trail);
                                trailCount--;
                            }
                        }, 2000);
                    };

                    // Create trail every 250ms (slightly slower for performance)
                    const trailInterval = setInterval(createTrail, 250);

                    // Cleanup after animation
                    setTimeout(() => {
                        if (sleigh.parentNode) {
                            sleigh.parentNode.removeChild(sleigh);
                        }
                        clearInterval(trailInterval);
                        // Clean up any remaining trails
                        const remainingTrails = mapContainer.querySelectorAll('.sleigh-trail');
                        remainingTrails.forEach(trail => {
                            if (trail.parentNode) {
                                trail.parentNode.removeChild(trail);
                            }
                        });
                        trailCount = 0;
                    }, 8000);
                };

                // Start first animation after a short delay
                setTimeout(createSleighElement, 500);

                // Repeat animation every 15 seconds (slightly longer for performance)
                sleighAnimation.current = setInterval(createSleighElement, 15000);
            };

            const handleClose = () => {
                if (sleighAnimation.current) {
                    clearInterval(sleighAnimation.current);
                }
                if (mapInstance.current) {
                    mapInstance.current.remove();
                    mapInstance.current = null;
                }
                onClose(false);
            };

            const handleMapClick = (e) => {
                e.stopPropagation();
            };

            if (!isVisible) return null;

            return (
                <div className="santa-map-modal" onClick={handleClose}>
                    <div className="santa-map-container" onClick={handleMapClick}>
                        <div className="map-controls">
                            <button
                                className="map-control-btn"
                                onClick={handleClose}
                                title="Close Map"
                            >
                                ‚úï
                            </button>
                            <button
                                className="map-control-btn"
                                onClick={() => {
                                    if (mapInstance.current && santaStats) {
                                        mapInstance.current.setView([santaStats.santaLat, santaStats.santaLon], 6);
                                    }
                                }}
                                title="Center on Santa"
                            >
                                üéÖ
                            </button>
                            {userLocation && (
                                <button
                                    className="map-control-btn"
                                    onClick={() => {
                                        if (mapInstance.current) {
                                            mapInstance.current.setView([userLocation.lat, userLocation.lon], 8);
                                        }
                                    }}
                                    title="Center on You"
                                >
                                    üìç
                                </button>
                            )}
                        </div>
                        <div ref={mapRef} className="santa-map"></div>
                        <div style={{
                            position: 'absolute',
                            bottom: '20px',
                            left: '20px',
                            background: 'rgba(255,255,255,0.9)',
                            padding: '15px',
                            borderRadius: '10px',
                            fontSize: '14px',
                            maxWidth: '300px'
                        }}>
                            <h4 style={{margin: '0 0 8px 0', color: '#dc2626'}}>üéÑ Santa's Live Location</h4>
                            <p style={{margin: '4px 0'}}><strong>Status:</strong> {santaStats?.status || 'Unknown'}</p>
                            {santaStats?.distance && (
                                <p style={{margin: '4px 0'}}><strong>Distance from you:</strong> {santaStats.distance.toLocaleString()} km</p>
                            )}
                            <p style={{margin: '4px 0', fontSize: '12px', opacity: '0.8'}}>Watch Santa fly across the map! ‚ú®</p>
                        </div>
                    </div>
                </div>
            );
        }

        function SantaTrackerEnhanced() {
            // Core state
            const [userLocation, setUserLocation] = useState(null);
            const [userLocationName, setUserLocationName] = useState('');
            const [showSantaMap, setShowSantaMap] = useState(false);
            const [locationPermission, setLocationPermission] = useState('prompt');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [santaStats, setSantaStats] = useState(null);
            const [santaMessage, setSantaMessage] = useState('');
            const [loadingMessage, setLoadingMessage] = useState(false);

            // Configuration state
            const [configLoaded, setConfigLoaded] = useState(false);
            const [configError, setConfigError] = useState(null);
            const [showConfigPanel, setShowConfigPanel] = useState(false);
            const [currentModel, setCurrentModel] = useState('');
            const [modelStatus, setModelStatus] = useState('unknown');
            const [availableModels, setAvailableModels] = useState([]);

            // Sound settings
            const [soundEnabled, setSoundEnabled] = useState(true);

            // Animation state
            const [gifts, setGifts] = useState([]);
            const giftIdCounter = useRef(0);

            // Nice List checker state
            const [showNiceListChecker, setShowNiceListChecker] = useState(false);
            const [niceListName, setNiceListName] = useState('');
            const [niceListResult, setNiceListResult] = useState(null);
            const [checkingNiceList, setCheckingNiceList] = useState(false);

            // Naughty List Management state
            const [customNaughtyList, setCustomNaughtyList] = useState([]);
            const [showNaughtyListManager, setShowNaughtyListManager] = useState(false);
            const [newNaughtyName, setNewNaughtyName] = useState('');

            // Language state
            const [currentLanguage, setCurrentLanguage] = useState('en');
            const [showLanguageSelector, setShowLanguageSelector] = useState(false);

            // Favorites state
            const [favoriteMessages, setFavoriteMessages] = useState([]);
            const [showFavorites, setShowFavorites] = useState(false);

            // Reindeer state
            const [reindeerTeam, setReindeerTeam] = useState([]);
            const [teamStatus, setTeamStatus] = useState({});
            const [showReindeerPanel, setShowReindeerPanel] = useState(false);

            // Weather state
            const [currentWeather, setCurrentWeather] = useState(null);
            const [weatherHistory, setWeatherHistory] = useState([]);
            const [weatherForecast, setWeatherForecast] = useState([]);
            const [showWeatherPanel, setShowWeatherPanel] = useState(false);

            // Chimney Safety state
            const [currentSafetyTip, setCurrentSafetyTip] = useState(null);
            const [allSafetyTips, setAllSafetyTips] = useState([]);
            const [safetyCategories, setSafetyCategories] = useState([]);
            const [showSafetyPanel, setShowSafetyPanel] = useState(false);


            // Initialize configuration system
            useEffect(() => {
                initializeConfiguration();
            }, []);

            // Time updates
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Santa progress calculations
            useEffect(() => {
                if (userLocation) {
                    calculateSantaProgress();
                }
            }, [userLocation, currentTime]);

            // Santa arrival sound effect
            useEffect(() => {
                if (santaStats && santaStats.timeUntil === 0 && userLocation) {
                    // Play Santa arrival sequence when he reaches user's area
                    soundManager.playSantaArrival();

                    // Drop multiple gifts when Santa arrives
                    createGiftShower(); // Use the spectacular shower for Santa's arrival
                }
            }, [santaStats?.timeUntil]);

            // Sync sound settings
            useEffect(() => {
                soundManager.setEnabled(soundEnabled);
            }, [soundEnabled]);

            // Initialize language and listen for changes
            useEffect(() => {
                // Set initial language from LanguageManager
                setCurrentLanguage(window.languageManager.getCurrentLanguage());

                // Listen for language changes
                const handleLanguageChange = (data) => {
                    setCurrentLanguage(data.to);
                };

                window.languageManager.addEventListener('language-changed', handleLanguageChange);

                return () => {
                    window.languageManager.removeEventListener('language-changed', handleLanguageChange);
                };
            }, []);

            // Load favorites from localStorage
            useEffect(() => {
                try {
                    const savedFavorites = localStorage.getItem('santa-tracker-favorites');
                    if (savedFavorites) {
                        const parsed = JSON.parse(savedFavorites);
                        setFavoriteMessages(parsed);
                        console.log('‚úÖ Loaded favorite messages from storage:', parsed.length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to load favorites from localStorage:', error);
                }
            }, []);

            // Load reindeer team and listen for updates
            useEffect(() => {
                // Load initial reindeer data
                const reindeer = window.reindeerManager.getAllReindeer();
                const status = window.reindeerManager.getTeamStatus();
                setReindeerTeam(reindeer);
                setTeamStatus(status);

                // Listen for reindeer updates
                const handleReindeerUpdate = (newStatus) => {
                    setTeamStatus(newStatus);
                    setReindeerTeam(window.reindeerManager.getAllReindeer());
                };

                window.reindeerManager.addEventListener('reindeer-updated', handleReindeerUpdate);

                return () => {
                    window.reindeerManager.removeEventListener('reindeer-updated', handleReindeerUpdate);
                };
            }, []);

            // Load weather system and listen for updates
            useEffect(() => {
                // Load initial weather data
                const weather = window.weatherManager.getCurrentWeather();
                const history = window.weatherManager.getWeatherHistory();
                const forecast = window.weatherManager.getWeatherForecast();

                setCurrentWeather(weather);
                setWeatherHistory(history);
                setWeatherForecast(forecast);

                // Listen for weather updates
                const handleWeatherUpdate = (newWeather) => {
                    setCurrentWeather(newWeather);
                    setWeatherHistory(window.weatherManager.getWeatherHistory());
                    setWeatherForecast(window.weatherManager.getWeatherForecast());
                };

                window.weatherManager.addEventListener('weather-updated', handleWeatherUpdate);

                return () => {
                    window.weatherManager.removeEventListener('weather-updated', handleWeatherUpdate);
                };
            }, []);

            // Load chimney safety system and listen for updates
            useEffect(() => {
                // Load initial safety data
                const currentTip = window.chimneySafetyManager.getCurrentTip();
                const allTips = window.chimneySafetyManager.getAllTips();
                const categories = window.chimneySafetyManager.getSafetyCategories();

                setCurrentSafetyTip(currentTip);
                setAllSafetyTips(allTips);
                setSafetyCategories(categories);

                // Listen for tip changes
                const handleTipChange = (newTip) => {
                    setCurrentSafetyTip(newTip);
                };

                window.chimneySafetyManager.addEventListener('tip-changed', handleTipChange);

                return () => {
                    window.chimneySafetyManager.removeEventListener('tip-changed', handleTipChange);
                };
            }, []);

            const toggleSound = () => {
                const newState = !soundEnabled;
                setSoundEnabled(newState);

                if (newState) {
                    // Play a test sound when enabling
                    setTimeout(() => soundManager.playNotification(), 100);
                }
            };

            const handleLanguageChange = (languageCode) => {
                setCurrentLanguage(languageCode);
                // Refresh reindeer data with new localization
                if (window.reindeerManager) {
                    window.reindeerManager.refreshLocalization();
                }
                console.log(`Language changed to: ${languageCode}`);
            };

            const saveFavoritesToStorage = (favorites) => {
                try {
                    localStorage.setItem('santa-tracker-favorites', JSON.stringify(favorites));
                    console.log('‚úÖ Favorites saved to localStorage');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to save favorites to localStorage:', error);
                }
            };

            const addToFavorites = (message) => {
                const favorite = {
                    id: Date.now(),
                    message: message,
                    timestamp: new Date().toISOString(),
                    language: currentLanguage
                };

                const updatedFavorites = [favorite, ...favoriteMessages].slice(0, 20); // Keep max 20 favorites
                setFavoriteMessages(updatedFavorites);
                saveFavoritesToStorage(updatedFavorites);

                soundManager.playNotification();
                console.log('‚≠ê Added message to favorites');
            };

            const removeFromFavorites = (id) => {
                const updatedFavorites = favoriteMessages.filter(fav => fav.id !== id);
                setFavoriteMessages(updatedFavorites);
                saveFavoritesToStorage(updatedFavorites);

                soundManager.playGiftDrop();
                console.log('üóëÔ∏è Removed message from favorites');
            };

            const isMessageFavorited = (message) => {
                return favoriteMessages.some(fav => fav.message === message);
            };

            // Load custom naughty list from localStorage
            useEffect(() => {
                try {
                    const savedNaughtyList = localStorage.getItem('santa-tracker-naughty-list');
                    if (savedNaughtyList) {
                        const parsed = JSON.parse(savedNaughtyList);
                        setCustomNaughtyList(parsed);
                        console.log('‚úÖ Loaded custom naughty list from storage:', parsed.length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to load naughty list from localStorage:', error);
                }
            }, []);

            const saveNaughtyListToStorage = (naughtyList) => {
                try {
                    localStorage.setItem('santa-tracker-naughty-list', JSON.stringify(naughtyList));
                    console.log('‚úÖ Naughty list saved to localStorage');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to save naughty list to localStorage:', error);
                }
            };

            const addToNaughtyList = (name) => {
                if (!name.trim()) return;

                const naughtyEntry = {
                    id: Date.now(),
                    name: name.trim(),
                    addedAt: new Date().toISOString()
                };

                const updatedList = [naughtyEntry, ...customNaughtyList];
                setCustomNaughtyList(updatedList);
                saveNaughtyListToStorage(updatedList);
                setNewNaughtyName('');

                soundManager.playGiftDrop();
                console.log('üìã Added to naughty list:', name);
            };

            const removeFromNaughtyList = (id) => {
                const updatedList = customNaughtyList.filter(entry => entry.id !== id);
                setCustomNaughtyList(updatedList);
                saveNaughtyListToStorage(updatedList);

                soundManager.playHoHoHo();
                console.log('‚ú® Removed from naughty list');
            };

            const isNameOnNaughtyList = (name) => {
                return customNaughtyList.some(entry =>
                    entry.name.toLowerCase() === name.toLowerCase().trim()
                );
            };

            const createGiftDrop = (isSpecial = false, customEmoji = null, targetLocation = null) => {
                const regularGifts = ['üéÅ', 'üéÄ', 'üì¶', 'üß∏', 'üç™', 'üé®', 'üìö', '‚öΩ', 'üéÆ', 'ü™Ä'];
                const specialGifts = ['‚ú®', 'üåü', 'üíé', 'üëë', 'üèÜ', 'üé™', 'ü¶Ñ', 'üåà'];
                const christmasGifts = ['üéÑ', '‚ùÑÔ∏è', '‚òÉÔ∏è', 'üîî', 'üïØÔ∏è', 'üéä', 'üéâ', 'üé∂'];
                const locationGifts = ['üéØ', 'üìç', 'üè†', 'üéä', 'üíù', 'üåü', '‚≠ê', '‚ú®'];

                let giftEmoji;
                let giftType = 'normal';

                // Special handling for location-targeted gifts
                if (targetLocation && targetLocation.isUserLocation) {
                    giftEmoji = customEmoji || locationGifts[Math.floor(Math.random() * locationGifts.length)];
                    giftType = 'user-targeted';
                } else if (customEmoji) {
                    giftEmoji = customEmoji;
                    giftType = 'custom';
                } else if (isSpecial || Math.random() < 0.15) {
                    // 15% chance for special gifts, or forced special
                    giftEmoji = specialGifts[Math.floor(Math.random() * specialGifts.length)];
                    giftType = 'special';
                } else if (Math.random() < 0.25) {
                    // 25% chance for Christmas-themed gifts
                    giftEmoji = christmasGifts[Math.floor(Math.random() * christmasGifts.length)];
                    giftType = 'christmas';
                } else {
                    giftEmoji = regularGifts[Math.floor(Math.random() * regularGifts.length)];
                }

                // Calculate X position based on target location or random
                let giftX;
                if (targetLocation) {
                    // Convert geo coordinates to screen position (simplified mapping)
                    const screenCenterX = window.innerWidth / 2;
                    const screenCenterY = window.innerHeight / 2;

                    if (targetLocation.isUserLocation) {
                        // Target user's area with some variation, responsive to screen size
                        const isMobile = window.innerWidth <= 768;
                        const areaPercentage = isMobile ? 0.3 : 0.2; // Larger area on mobile for better visibility
                        const maxArea = isMobile ? 150 : 200; // Smaller max area on mobile
                        const userArea = Math.min(window.innerWidth * areaPercentage, maxArea);
                        giftX = screenCenterX + (Math.random() * userArea - userArea/2);
                    } else {
                        giftX = targetLocation.x || (Math.random() * (window.innerWidth - 100));
                    }
                } else {
                    giftX = Math.random() * (window.innerWidth - 100);
                }

                // Ensure gift stays within screen bounds
                giftX = Math.max(50, Math.min(window.innerWidth - 50, giftX));

                const randomRotation = Math.random() * 360;
                const randomDelay = Math.random() * 200; // Slight delay variation

                const newGift = {
                    id: giftIdCounter.current++,
                    emoji: giftEmoji,
                    x: giftX,
                    type: giftType,
                    rotation: randomRotation,
                    delay: randomDelay,
                    createdAt: Date.now(),
                    isUserTargeted: targetLocation && targetLocation.isUserLocation
                };

                // Performance optimization: limit maximum gifts on screen
                setGifts(prev => {
                    const updatedGifts = [...prev, newGift];
                    // Keep only the latest 20 gifts for performance
                    return updatedGifts.length > 20 ? updatedGifts.slice(-20) : updatedGifts;
                });

                // Enhanced effects for user-targeted gifts
                if (giftType === 'user-targeted') {
                    setTimeout(() => createLocationTargetEffect(giftX), randomDelay);
                    setTimeout(() => createSparkleEffect(giftX, true), randomDelay + 500);
                } else if (giftType === 'special') {
                    setTimeout(() => createSparkleEffect(giftX), randomDelay);
                }

                // Create trail effects for all gifts
                setTimeout(() => createTrailEffect(giftX, giftEmoji), randomDelay + 500);

                // Remove gift after animation completes (longer for special and user-targeted gifts)
                const animationDuration = (giftType === 'special' || giftType === 'user-targeted') ? 5500 : 4500;
                setTimeout(() => {
                    setGifts(prev => prev.filter(g => g.id !== newGift.id));
                }, animationDuration);
            };

            const createLocationTargetEffect = (x) => {
                // Create a targeting indicator before the gift drops
                const targetIndicators = ['üéØ', 'üìç', 'üé™'];

                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const indicator = {
                            id: giftIdCounter.current++,
                            emoji: targetIndicators[Math.floor(Math.random() * targetIndicators.length)],
                            x: x + (Math.random() * 40 - 20), // Small spread
                            type: 'location-target',
                            createdAt: Date.now()
                        };

                        setGifts(prev => [...prev, indicator]);

                        setTimeout(() => {
                            setGifts(prev => prev.filter(g => g.id !== indicator.id));
                        }, 800);
                    }, i * 100);
                }
            };

            const createSparkleEffect = (x, enhanced = false) => {
                const sparkleEmojis = enhanced ?
                    ['‚ú®', '‚≠ê', 'üí´', 'üåü', 'üéä', 'üéâ', 'üíù'] :
                    ['‚ú®', '‚≠ê', 'üí´', 'üåü'];

                const sparkleCount = enhanced ? 5 : 3;

                for (let i = 0; i < sparkleCount; i++) {
                    setTimeout(() => {
                        const sparkle = {
                            id: giftIdCounter.current++,
                            emoji: sparkleEmojis[Math.floor(Math.random() * sparkleEmojis.length)],
                            x: x + (Math.random() * 60 - 30), // Spread around the gift
                            type: 'sparkle',
                            createdAt: Date.now()
                        };

                        setGifts(prev => [...prev, sparkle]);

                        setTimeout(() => {
                            setGifts(prev => prev.filter(g => g.id !== sparkle.id));
                        }, 1000);
                    }, i * 200);
                }
            };

            const createTrailEffect = (x, emoji) => {
                // Create a smaller trail version of the gift
                const trail = {
                    id: giftIdCounter.current++,
                    emoji: emoji,
                    x: x,
                    type: 'trail',
                    createdAt: Date.now()
                };

                setGifts(prev => [...prev, trail]);

                setTimeout(() => {
                    setGifts(prev => prev.filter(g => g.id !== trail.id));
                }, 800);
            };

            const createMultipleGifts = (count = 3, includeSpecial = false) => {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const isSpecial = includeSpecial && i === count - 1; // Make last gift special
                        createGiftDrop(isSpecial);
                    }, i * 300); // Slightly faster succession
                }
            };

            // New function for location-based gift drops
            const createUserLocationGiftDrop = (customEmoji = null) => {
                if (!userLocation) {
                    // Fallback to regular gift drop if no location
                    createGiftDrop(true, customEmoji);
                    return;
                }

                const locationTarget = {
                    isUserLocation: true,
                    lat: userLocation.lat,
                    lon: userLocation.lon
                };

                createGiftDrop(false, customEmoji, locationTarget);

                // Show a special message about the targeted gift
                // Create responsive notification
                const isMobile = window.innerWidth <= 768;
                const messageEl = document.createElement('div');
                messageEl.innerHTML = `
                    <div style="
                        position: fixed;
                        top: ${isMobile ? '10px' : '20px'};
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #ff6b6b, #ffa500);
                        color: white;
                        padding: ${isMobile ? '12px 20px' : '15px 25px'};
                        border-radius: 25px;
                        font-size: ${isMobile ? '14px' : '16px'};
                        font-weight: bold;
                        z-index: 10000;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        animation: slideDown 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        max-width: ${isMobile ? '90vw' : '400px'};
                        text-align: center;
                    ">
                        üéØ ${window.languageManager.t('giftDrop.targetedDelivery') || 'Special delivery headed your way!'} üéÅ
                    </div>
                `;

                document.body.appendChild(messageEl);
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.remove();
                    }
                }, 3000);
            };

            const createGiftShower = () => {
                // Create a spectacular gift shower
                const totalGifts = 8;
                const specialGiftIndex = Math.floor(totalGifts / 2);

                for (let i = 0; i < totalGifts; i++) {
                    setTimeout(() => {
                        createGiftDrop(i === specialGiftIndex);
                    }, i * 150);
                }

                // Add some extra sparkles
                setTimeout(() => {
                    createSparkleEffect(window.innerWidth / 4);
                    createSparkleEffect((window.innerWidth / 4) * 3);
                }, 1000);
            };

            const createSeasonalGifts = () => {
                const now = new Date();
                const christmasEve = now.getMonth() === 11 && now.getDate() === 24;
                const christmasDay = now.getMonth() === 11 && now.getDate() === 25;

                if (christmasEve || christmasDay) {
                    // Special Christmas gifts
                    const christmasGifts = ['üéÑ', '‚≠ê', '‚ùÑÔ∏è', 'üîî'];
                    christmasGifts.forEach((gift, index) => {
                        setTimeout(() => {
                            createGiftDrop(true, gift);
                        }, index * 400);
                    });
                } else {
                    createMultipleGifts(4, true);
                }
            };

            const checkNiceList = async () => {
                if (!niceListName.trim() || checkingNiceList) return;

                setCheckingNiceList(true);
                setNiceListResult(null);

                try {
                    // Use language-aware prompt from LanguageManager
                    const prompt = window.languageManager.getNiceListPromptPrefix(niceListName);

                    let aiConfig = {};
                    if (configLoaded) {
                        const modelConfig = window.configManager.getCurrentModel();
                        if (modelConfig) {
                            // Korean-specific configuration for Nice List
                            if (currentLanguage === 'ko') {
                                aiConfig = {
                                    model: modelConfig.name,
                                    options: {
                                        temperature: 0.1,     // ULTRA low for Korean consistency
                                        top_p: 0.6,          // Very focused
                                        top_k: 20,           // Limited vocabulary
                                        repeat_penalty: 1.3, // Higher repetition penalty
                                        num_predict: 80,     // Moderate length to prevent truncation
                                        stop: ["„Åß„Åô", "„Å†", "„Åæ„Åô", "„Åô„Çã", "„Åü„Å°", "„Å®„ÅÑ„ÅÜ", "„ÇØ„É™„Çπ", "„Éû„Çπ", "Âñú„Å≥", "t·∫•t c·∫£", "c·ªßa", "nh·ªØng", "v√†", "happiness", "joy", "wonderful", "children", "magic", "magical", "people", "beautiful", "amazing", "special", "perfect", "ingly", "ness", "tion", "ly", "ing", "ÁöÑ", "‰∫Ü", "Âíå", "Âú®", "‰ª¨", "ÊúÉ", "‰ºö", "ÈÉΩ", "‰πü", "orden", "amor", "feliz", "navidad", "‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏Ñ‡πà‡∏∞", "‡πÅ‡∏•‡∏∞", "‡∏ó‡∏µ‡πà", "–∏", "–≤", "na", "—Å"], // Stop on all foreign words
                                        ...modelConfig.parameters
                                    }
                                };
                            } else {
                                aiConfig = {
                                    model: modelConfig.name,
                                    options: {
                                        temperature: 0.9, // Higher creativity for fun responses
                                        num_predict: 100,
                                        ...modelConfig.parameters
                                    }
                                };
                            }
                        }
                    } else {
                        // Fallback configuration with Korean optimization
                        if (currentLanguage === 'ko') {
                            aiConfig = {
                                model: 'llama3.2',
                                options: {
                                    temperature: 0.1,     // ULTRA low for Korean consistency
                                    top_p: 0.6,          // Very focused
                                    top_k: 20,           // Limited vocabulary
                                    repeat_penalty: 1.3, // Higher repetition penalty
                                    num_predict: 80,     // Moderate length to prevent truncation
                                    stop: ["„Åß„Åô", "„Å†", "„Åæ„Åô", "„Åü„Å°", "„ÇØ„É™„Çπ", "„Éû„Çπ", "Âñú„Å≥", "t·∫•t c·∫£", "c·ªßa", "happiness", "joy", "wonderful", "children", "magical", "people", "ingly", "ness", "ÁöÑ", "‰∫Ü", "‰ª¨", "orden", "amor", "feliz", "—á—Ç–æ", "–∫–∞–∫"] // Stop on very specific foreign words only
                                }
                            };
                        } else {
                            aiConfig = {
                                model: 'llama3.2',
                                options: {
                                    temperature: 0.9,
                                    num_predict: 100
                                }
                            };
                        }
                    }

                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            stream: false,
                            ...aiConfig
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    const result = data.response || '';

                    // Check if name is on custom naughty list first
                    if (isNameOnNaughtyList(niceListName)) {
                        const naughtyEntry = customNaughtyList.find(entry =>
                            entry.name.toLowerCase() === niceListName.toLowerCase().trim()
                        );
                        setNiceListResult({
                            name: niceListName,
                            status: 'NAUGHTY',
                            message: currentLanguage === 'ko'
                                ? `${niceListName}Îãò, Ï†úÍ∞Ä ÎßåÎì† ÎßêÏçΩÍæ∏Îü¨Í∏∞ Î™©Î°ùÏóê ÏûàÏúºÏãúÎÑ§Ïöî! Îçî Ï∞©ÌïòÍ≤å ÌñâÎèôÌï¥Ïïº ÌÅ¨Î¶¨Ïä§ÎßàÏä§Ïóê ÏÑ†Î¨ºÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî! üéÑ`
                                : `${niceListName}, you're on my custom Naughty List! Be good and you might get presents this Christmas! üéÑ`,
                            isCustom: true
                        });
                        soundManager.playGiftDrop();
                        return;
                    }

                    // Parse the AI result
                    const lines = result.split('\n');
                    let status = 'NICE'; // Default to nice
                    let message = currentLanguage === 'ko'
                        ? `Ìò∏Ìò∏Ìò∏! ${niceListName}Îãò, Ïò¨Ìï¥ Ï∞©Ìïú ÏïÑÏù¥ Î™©Î°ùÏóê ÌôïÏã§Ìûà ÏûàÏúºÏãúÎÑ§Ïöî!`
                        : `Ho ho ho! ${niceListName}, you're definitely on my Nice List this year!`;

                    for (const line of lines) {
                        if (line.startsWith('STATUS:')) {
                            const statusMatch = line.match(/STATUS:\s*(NICE|NAUGHTY)/i);
                            if (statusMatch) {
                                status = statusMatch[1].toUpperCase();
                            }
                        }
                        if (line.startsWith('MESSAGE:')) {
                            const messageMatch = line.match(/MESSAGE:\s*(.+)/i);
                            if (messageMatch) {
                                message = messageMatch[1].trim();
                            }
                        }
                    }

                    setNiceListResult({
                        name: niceListName,
                        status: status,
                        message: message
                    });

                    // Play appropriate sound and animation
                    if (status === 'NICE') {
                        soundManager.playHoHoHo();
                        createSeasonalGifts(); // Use seasonal gifts for nice list reward
                    } else {
                        soundManager.playNotification();
                    }

                    console.log('‚úÖ Nice List check completed');

                } catch (error) {
                    console.error('‚ùå Error checking Nice List:', error);
                    setNiceListResult({
                        name: niceListName,
                        status: 'NICE',
                        message: `Ho ho ho! Don't worry ${niceListName}, my magical Nice List checker is taking a little break, but I can tell you're definitely on the Nice List! üéÖ‚ú®`
                    });
                } finally {
                    setCheckingNiceList(false);
                }
            };

            const initializeConfiguration = async () => {
                try {
                    console.log('üéÑ Initializing Santa Tracker configuration system...');

                    // Try to load configuration
                    await window.configManager.load();

                    // Get current model info
                    const current = window.configManager.getCurrentModel();
                    setCurrentModel(current?.displayName || current?.name || 'Unknown');

                    // Get available models
                    const models = window.configManager.getAvailableModels();
                    setAvailableModels(models);

                    // Set up configuration change listeners
                    window.configManager.addEventListener('config-changed', handleConfigChange);

                    setConfigLoaded(true);
                    setModelStatus('configured');
                    console.log('‚úÖ Configuration system initialized successfully');

                    // Play a welcome jingle to indicate the app is ready
                    setTimeout(() => {
                        soundManager.playJingleBells(false);
                    }, 500);

                } catch (error) {
                    console.error('‚ùå Failed to initialize configuration:', error);
                    setConfigError(error.message);
                    setConfigLoaded(false);

                    // Still allow the app to work with fallback values
                    setCurrentModel('llama3.2 (fallback)');
                    setModelStatus('fallback');
                    setAvailableModels([
                        { name: 'llama3.2', displayName: 'Llama 3.2', description: 'Default fallback model' }
                    ]);
                }
            };

            const handleConfigChange = (data) => {
                console.log('Configuration changed:', data.path);

                // Reload Santa progress if relevant settings changed
                if (data.path.startsWith('prompts') || data.path.startsWith('aiProvider')) {
                    calculateSantaProgress();
                }
            };

            const handleModelChange = (modelName) => {
                try {
                    if (configLoaded) {
                        // Play jingle bells when switching models
                        soundManager.playJingleBells(false);

                        window.configManager.setCurrentModel(modelName);
                        const newModel = window.configManager.getCurrentModel();
                        setCurrentModel(newModel?.displayName || modelName);
                    }

                    // Clear current message so it will be regenerated with new model
                    setSantaMessage('');
                    setShowConfigPanel(false);

                    console.log('Model changed to:', modelName);
                } catch (error) {
                    console.error('Failed to change model:', error);
                }
            };

            const requestLocation = () => {
                // Play sleigh bells when starting location request
                soundManager.playSleighBells();

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const location = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            setUserLocation(location);

                            // Get human-readable location name
                            try {
                                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${location.lat}&longitude=${location.lon}&localityLanguage=${currentLanguage}`);
                                const data = await response.json();

                                const city = data.city || data.locality || data.principalSubdivision || '';
                                const country = data.countryName || '';

                                let locationName;
                                if (city && country) {
                                    locationName = `${city}, ${country}`;
                                } else if (country) {
                                    locationName = country;
                                } else {
                                    locationName = `${location.lat.toFixed(2)}¬∞, ${location.lon.toFixed(2)}¬∞`;
                                }
                                setUserLocationName(locationName);
                                console.log('üìç Location obtained:', locationName);
                            } catch (error) {
                                console.warn('Reverse geocoding failed:', error);
                                setUserLocationName(`${location.lat.toFixed(2)}¬∞, ${location.lon.toFixed(2)}¬∞`);
                            }

                            setLocationPermission('granted');

                            // Play gift drop sound and create a welcome location-targeted gift
                            soundManager.playGiftDrop();

                            // Create a special welcome gift targeted at the user's location
                            setTimeout(() => {
                                createUserLocationGiftDrop('üéØ'); // Special targeting emoji for first location gift
                            }, 1000);
                        },
                        (error) => {
                            console.error('Location error:', error);
                            setLocationPermission('denied');
                        }
                    );
                }
            };

            const calculateSantaProgress = () => {
                const now = new Date();
                const christmasEve = new Date(now.getFullYear(), 11, 24, 18, 0, 0);
                const christmasDay = new Date(now.getFullYear(), 11, 25, 6, 0, 0);

                const totalDeliveryHours = 24;
                const hoursIntoDelivery = (now - christmasEve) / (1000 * 60 * 60);

                let santaLon, santaLat;
                let status;
                let distance;
                let timeUntil;
                let giftsDelivered;

                if (now < christmasEve) {
                    santaLon = -180;
                    santaLat = 90;
                    status = window.languageManager.t('status.preparing');
                    timeUntil = Math.floor((christmasEve - now) / (1000 * 60 * 60));
                    giftsDelivered = 0;
                } else if (now >= christmasEve && now < christmasDay) {
                    const progress = hoursIntoDelivery / totalDeliveryHours;
                    santaLon = 180 - (progress * 360);
                    santaLat = 45 + Math.sin(progress * Math.PI * 4) * 20;
                    status = window.languageManager.t('status.delivering');
                    giftsDelivered = Math.floor(progress * 2000000000);

                    if (userLocation) {
                        const userLon = userLocation.lon;
                        if (santaLon < userLon) {
                            status = window.languageManager.t('status.visited');
                        } else {
                            const lonDiff = santaLon - userLon;
                            const hoursAway = (lonDiff / 360) * totalDeliveryHours;
                            timeUntil = Math.max(0, Math.floor(hoursAway));
                            const hoursText = timeUntil !== 1 ? window.languageManager.t('stats.hoursPlural') : window.languageManager.t('stats.hours');
                            status = window.languageManager.t('status.hoursAway', {hours: timeUntil, hoursText: hoursText});
                        }
                    }
                } else {
                    santaLon = -180;
                    santaLat = 90;
                    status = window.languageManager.t('status.finished');
                    giftsDelivered = 2000000000;
                }

                if (userLocation && now >= christmasEve && now < christmasDay) {
                    const R = 6371;
                    const dLat = (santaLat - userLocation.lat) * Math.PI / 180;
                    const dLon = (santaLon - userLocation.lon) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                              Math.cos(userLocation.lat * Math.PI / 180) * Math.cos(santaLat * Math.PI / 180) *
                              Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    distance = Math.floor(R * c);
                }

                setSantaStats({
                    status,
                    distance,
                    timeUntil,
                    giftsDelivered,
                    santaLon,
                    santaLat
                });
            };

            // Simplified Korean language purity validation function (85% Hangeul rule)
            const validateKoreanPurity = (message) => {
                console.log('üîç Checking Korean purity for message:', message.trim());

                // Count total characters (excluding spaces and punctuation)
                const totalChars = message.replace(/[\s\p{P}\p{So}0-9]/gu, '').length;

                // Count Hangeul characters (Korean alphabet)
                const hangeulChars = (message.match(/[Í∞Ä-Ìû£]/g) || []).length;

                // Calculate purity percentage
                const purityPercentage = totalChars > 0 ? (hangeulChars / totalChars) * 100 : 0;

                console.log(`üìä Korean purity analysis: ${hangeulChars}/${totalChars} characters = ${purityPercentage.toFixed(1)}%`);

                if (purityPercentage >= 85) {
                    console.log('‚úÖ Korean purity validation passed (‚â•85% Hangeul)');
                    return message;
                } else {
                    console.log(`‚ùå Korean purity validation failed (${purityPercentage.toFixed(1)}% < 85% Hangeul)`);

                    // Return a safe, pure Korean fallback message
                    const fallbackMessages = [
                        "Ìò∏Ìò∏Ìò∏! Î∂ÅÍ∑πÏóêÏÑú ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ï§ÄÎπÑÍ∞Ä ÌïúÏ∞ΩÏûÖÎãàÎã§. ÏóòÌîÑÎì§Í≥º ÏàúÎ°ùÎì§Ïù¥ Î™®Îëê Î∞îÏÅòÍ≤å ÏõÄÏßÅÏù¥Í≥† ÏûàÏñ¥Ïöî! üéÖ",
                        "Ìò∏Ìò∏Ìò∏! Ï†ÑÏÑ∏Í≥Ñ Ï∞©Ìïú ÏïÑÏù¥Îì§ÏóêÍ≤å ÏÑ†Î¨ºÏùÑ ÎÇòÎàÑÏñ¥ Ï§Ñ ÏÉùÍ∞ÅÏóê ÎßàÏùåÏù¥ ÏÑ§Î†ôÎãàÎã§. Ïò¨Ìï¥ÎèÑ Ï¶êÍ±∞Ïö¥ ÌÅ¨Î¶¨Ïä§ÎßàÏä§Í∞Ä Îê† Í≤É Í∞ôÏïÑÏöî! üéÅ",
                        "Ìò∏Ìò∏Ìò∏! ÏàúÎ°ùÎì§Í≥º Ìï®Íªò ÌïòÎäòÏùÑ ÎÇ†Î©∞ Î™®Îì† Í∞ÄÏ†ïÏóê Îî∞ÎúªÌï®ÏùÑ Ï†ÑÌï¥ÎìúÎ¶¨Í≥† ÏûàÎãµÎãàÎã§. Î©ãÏßÑ ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÎêòÏÑ∏Ïöî! ü¶å",
                        "Ìò∏Ìò∏Ìò∏! ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î∏åÍ∞Ä Îã§Í∞ÄÏôÄÏÑú Ï†ïÎßê Ïã†ÎÇòÏöî! ÏóòÌîÑÎì§Ïù¥ Ïó¥Ïã¨Ìûà ÏÑ†Î¨ºÏùÑ Ï§ÄÎπÑÌïòÍ≥† ÏûàÏñ¥Ïöî! ‚ú®",
                        "Ìò∏Ìò∏Ìò∏! Ï∞©Ìïú ÏïÑÏù¥Îì§ÏùÑ ÏúÑÌï¥ ÌäπÎ≥ÑÌïú ÏÑ†Î¨ºÏùÑ Ï§ÄÎπÑÌñàÏñ¥Ïöî. Í≥ß Ïó¨Îü¨Î∂ÑÏùÑ ÎßåÎÇ† Ïàò ÏûàÏùÑ Í±∞ÏòàÏöî! üéÑ",
                        "Ìò∏Ìò∏Ìò∏! Î£®ÎèåÌîÑÏôÄ ÏàúÎ°ù ÏπúÍµ¨Îì§ÎèÑ Î™®Îëê Ï§ÄÎπÑÎêêÏñ¥Ïöî! ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Î∞§Ïù¥ Ï†ïÎßê Í∏∞ÎåÄÎê©ÎãàÎã§! üõ∑"
                    ];
                    const randomIndex = Math.floor(Math.random() * fallbackMessages.length);
                    console.log(`‚úÖ Using pure Korean fallback message (100% Hangeul purity)`);
                    return fallbackMessages[randomIndex];
                }
            };

            const getSantaMessage = async () => {
                if (loadingMessage) return;

                // Play notification sound when generating message
                soundManager.playNotification();

                setLoadingMessage(true);
                setSantaMessage('');

                try {
                    let prompt = '';
                    let aiConfig = {};

                    if (configLoaded) {
                        // Use new configuration system
                        console.log('üéÑ Using enhanced configuration system for Santa message');

                        // Generate context-aware prompt using PromptManager
                        prompt = window.promptManager.generateSantaMessage(santaStats, userLocation);

                        // Get current model configuration with Korean-specific optimizations
                        const modelConfig = window.configManager.getCurrentModel();

                        // Use more conservative settings for Korean to improve consistency
                        const baseOptions = modelConfig?.parameters || {
                            temperature: 0.8,
                            num_predict: 500  // Default to higher token count for thinking models
                        };

                        // Debug logging for configuration issues
                        console.log('üîß Model config debug:');
                        console.log('   Current model:', window.configManager.get('aiProvider.defaultModel'));
                        console.log('   Model config object:', modelConfig);
                        console.log('   Base options being used:', baseOptions);

                        // Korean-specific AI configuration with optimized models
                        if (currentLanguage === 'ko') {
                            // Use Korean-optimized models - gemma3 first as it's known working
                            const koreanModels = ['gemma3:latest', 'qwen3:latest'];
                            const currentModel = window.configManager.get('aiProvider.defaultModel');

                            // Use Korean-optimized model (qwen3:latest is now working properly)
                            const preferredModel = koreanModels.includes(currentModel) ? currentModel : koreanModels[0];
                            console.log('üá∞üá∑ Using Korean-optimized model:', preferredModel);

                            aiConfig = {
                                model: preferredModel,
                                options: {
                                    ...baseOptions,
                                    temperature: 0.8,    // Higher temperature for more creativity
                                    top_p: 0.9,         // More flexible sampling
                                    top_k: 50,          // More vocabulary choices
                                    repeat_penalty: 1.1  // Lower repetition penalty
                                    // num_predict comes from baseOptions (config)
                                }
                            };
                        } else {
                            aiConfig = {
                                model: window.configManager.get('aiProvider.defaultModel'),
                                options: baseOptions
                            };
                        }

                    } else {
                        // Fallback to old hardcoded approach
                        console.log('‚ö†Ô∏è Using fallback configuration for Santa message');

                        const now = new Date();
                        const christmasEve = new Date(now.getFullYear(), 11, 24, 18, 0, 0);
                        const christmasDay = new Date(now.getFullYear(), 11, 25, 6, 0, 0);

                        let context = '';
                        if (now < christmasEve) {
                            context = currentLanguage === 'ko'
                                ? 'ÏÇ∞ÌÉÄÎäî ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î∏åÎ•º ÏúÑÌï¥ Î∂ÅÍ∑πÏóêÏÑú Ï§ÄÎπÑÌïòÍ≥† ÏûàÏäµÎãàÎã§. ÏóòÌîÑÎì§Ïù¥ ÏÑ†Î¨ºÏùÑ Ìè¨Ïû•ÌïòÎäêÎùº Î∞îÏÅ©ÎãàÎã§.'
                                : 'Santa is at the North Pole preparing for Christmas Eve. The elves are busy wrapping presents.';
                        } else if (now >= christmasEve && now < christmasDay) {
                            if (currentLanguage === 'ko') {
                                context = `ÏÇ∞ÌÉÄÍ∞Ä ÌòÑÏû¨ Ï†ÑÏÑ∏Í≥ÑÏóê ÏÑ†Î¨ºÏùÑ Î∞∞Îã¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§! ${
                                    santaStats?.distance
                                        ? `ÏÇ∞ÌÉÄÎäî ÎãπÏã†Ïùò ÏúÑÏπòÏóêÏÑú ÏïΩ ${santaStats.distance.toLocaleString()}km Îñ®Ïñ¥Ï†∏ ÏûàÏäµÎãàÎã§.`
                                        : 'Ï†Ñ ÏÑ∏Í≥ÑÎ•º ÎèåÏïÑÎã§ÎãàÍ≥† ÏûàÏäµÎãàÎã§.'
                                } ${santaStats?.giftsDelivered ? `ÏßÄÍ∏àÍπåÏßÄ ${santaStats.giftsDelivered.toLocaleString()}Í∞úÏùò ÏÑ†Î¨ºÏùÑ Î∞∞Îã¨ÌñàÏäµÎãàÎã§!` : ''}`;
                            } else {
                                context = `Santa is currently delivering presents around the world! ${
                                    santaStats?.distance
                                        ? `He is about ${santaStats.distance.toLocaleString()} km away from the user's location.`
                                        : 'He is making his way across the globe.'
                                } ${santaStats?.giftsDelivered ? `He has delivered ${santaStats.giftsDelivered.toLocaleString()} gifts so far!` : ''}`;
                            }
                        } else {
                            context = currentLanguage === 'ko'
                                ? 'ÏÇ∞ÌÉÄÍ∞Ä ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Î∞∞Îã¨ÏùÑ ÎßàÏπòÍ≥† ÏàúÎ°ùÎì§Í≥º Ìï®Íªò Î∂ÅÍ∑πÏóêÏÑú Ïâ¨Í≥† ÏûàÏäµÎãàÎã§.'
                                : 'Santa has finished his Christmas deliveries and is resting at the North Pole with the reindeer.';
                        }

                        // Simple, clean Korean prompt
                        prompt = `ÎãπÏã†ÏùÄ ÏÇ∞ÌÉÄÌÅ¥Î°úÏä§ÏûÖÎãàÎã§. Îã§Ïùå ÏÉÅÌô©Ïóê ÎåÄÌï¥ Îî∞ÎúªÌïòÍ≥† Ï¶êÍ±∞Ïö¥ ÌïúÍµ≠Ïñ¥ Î©îÏãúÏßÄÎ•º 2-3Î¨∏Ïû•ÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:

${context}

ÌïúÍµ≠Ïñ¥Î°úÎßå ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:`;

                        // For English, use the original format
                        if (currentLanguage !== 'ko') {
                            const santaPromptPrefix = window.languageManager.getSantaPromptPrefix();
                            prompt = `${santaPromptPrefix}${context} Be jolly, mention the reindeer if relevant, and keep it magical and brief. Use emojis sparingly (1-2 max). Don't use quotation marks.`;
                        }

                        // Korean-specific AI configuration for fallback
                        if (currentLanguage === 'ko') {
                            // Use qwen3:latest for Korean (now working with proper tokens)
                            console.log('üá∞üá∑ Using fallback Korean model: qwen3:latest');
                            aiConfig = {
                                model: "qwen3:latest",
                                options: {
                                    temperature: 0.8,    // Higher temperature for more creativity
                                    top_p: 0.9,         // More flexible sampling
                                    top_k: 50,          // More vocabulary choices
                                    repeat_penalty: 1.1, // Lower repetition penalty
                                    num_predict: 500     // Sufficient for qwen3:latest thinking mechanism
                                }
                            };
                        } else {
                            aiConfig = {
                                model: "llama3:latest",
                                options: {
                                    temperature: 0.8,
                                    num_predict: 150  // Sufficient for English responses
                                }
                            };
                        }
                    }

                    // Get Ollama URL
                    const ollamaUrl = configLoaded
                        ? window.configManager.get('aiProvider.url')
                        : "http://localhost:11434";

                    // Make API request through server proxy
                    const requestData = {
                        model: aiConfig.model,
                        prompt: prompt,
                        stream: false,
                        options: aiConfig.options
                    };

                    console.log('üöÄ Making AI request:');
                    console.log('   Model:', requestData.model);
                    console.log('   Prompt:', requestData.prompt?.substring(0, 150) + '...');
                    console.log('   Options:', JSON.stringify(requestData.options, null, 2));

                    const response = await fetch("/api/generate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('üì• Response status:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå API error response:', errorText);
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('üì¶ Response data:');
                    console.log('   Response field:', data.response);
                    console.log('   Done:', data.done);
                    console.log('   Full data:', JSON.stringify(data, null, 2));
                    let message = data.response || '';

                    console.log('üìù Extracted message length:', message.length, 'Content:', message);

                    // Korean language purity validation
                    if (currentLanguage === 'ko') {
                        console.log('üîç Raw AI message before validation:', message.trim());

                        // Temporary: Allow bypass for debugging (remove after testing)
                        const debugMode = window.location.hash.includes('debug');
                        if (debugMode) {
                            console.log('üöß DEBUG MODE: Skipping validation, using raw AI message');
                        } else {
                            message = validateKoreanPurity(message.trim());
                        }

                        console.log('‚ú® Final message after validation:', message);
                    }

                    setSantaMessage(message);

                    // Play ho ho ho sound when message is successfully generated
                    soundManager.playHoHoHo();

                    // Drop a location-targeted gift when user has location, otherwise regular gift
                    if (userLocation && Math.random() < 0.7) { // 70% chance for location-targeted gift when location is available
                        createUserLocationGiftDrop();
                    } else {
                        createGiftDrop(Math.random() < 0.3); // 30% chance for special gift
                    }

                    console.log('‚úÖ Santa message generated successfully');

                } catch (error) {
                    console.error('‚ùå Error getting Santa message:', error);

                    // User-friendly localized error message
                    const errorMessage = window.languageManager.t('santaMessage.error') ||
                        (currentLanguage === 'ko'
                            ? 'Ìò∏Ìò∏Ìò∏! ÏÇ∞ÌÉÄÏùò ÎßàÎ≤ï Î©îÏãúÏßÄ ÏãúÏä§ÌÖúÏù¥ Ïû†Ïãú ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ìú¥ÏãùÏùÑ Ï∑®ÌïòÍ≥† ÏûàÏñ¥Ïöî. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî! üéÖ‚ú®'
                            : 'Ho ho ho! My magical messaging system seems to be taking a little Christmas break. Please try again in a moment! üéÖ‚ú®');

                    setSantaMessage(errorMessage);
                } finally {
                    setLoadingMessage(false);
                }
            };

            // Configuration status indicator
            const ConfigStatus = () => {
                if (!configLoaded) {
                    return (
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
                            <div className="flex">
                                <span style={{fontSize: '20px', color: '#fbbf24', marginRight: '8px'}}>‚ö†Ô∏è</span>
                                <div>
                                    <p className="text-sm text-yellow-700 font-medium">Configuration Issue</p>
                                    <p className="text-xs text-yellow-600">
                                        {configError || 'Using fallback configuration'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="bg-green-50 border-l-4 border-green-400 p-3 mb-4">
                        <div className="flex items-center">
                            <div className="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <p className="text-sm text-green-700">
                                <span className="font-medium">{window.languageManager.t('config.santaMagic')}</span> {window.languageManager.t('config.readyOperational')} ‚ú®
                            </p>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-blue-900 via-blue-800 to-blue-900 p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Configuration Status */}
                        <ConfigStatus />

                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="flex items-center justify-center mb-4 flex-wrap sm:flex-nowrap gap-2 sm:gap-0">
                                <h1 className="text-6xl font-bold text-white drop-shadow-lg mr-4 whitespace-nowrap">
                                    {window.languageManager.t('app.title')}
                                </h1>
                                <div className="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
                                    ‚úÖ {window.languageManager.t('config.fixed')}
                                </div>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={toggleSound}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105"
                                        title={soundEnabled ? window.languageManager.t('tooltip.disableSound') : window.languageManager.t('tooltip.enableSound')}
                                    >
                                        {soundEnabled ?
                                            <span className="text-xl">üîä</span> :
                                            <span className="text-xl">üîá</span>
                                        }
                                    </button>
                                    <button
                                        onClick={() => {
                                            soundManager.playGiftDrop();
                                            // Randomly choose between different gift drop types
                                            const dropType = Math.random();
                                            if (dropType < 0.3) {
                                                createGiftShower();
                                            } else if (dropType < 0.6) {
                                                createSeasonalGifts();
                                            } else {
                                                createMultipleGifts(4, true);
                                            }
                                        }}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105"
                                        title={window.languageManager.t('tooltip.dropGifts')}
                                    >
                                        <span className="text-xl">üéÅ</span>
                                    </button>
                                    <button
                                        onClick={() => setShowNiceListChecker(true)}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105"
                                        title={window.languageManager.t('tooltip.checkNiceList')}
                                    >
                                        <span className="text-xl">üìã</span>
                                    </button>
                                    <button
                                        onClick={() => setShowLanguageSelector(true)}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105"
                                        title={window.languageManager.t('tooltip.language', {language: window.languageManager.getLanguageNativeName(currentLanguage)})}
                                    >
                                        <span style={{fontSize: '24px'}}>üåç</span>
                                    </button>
                                    <button
                                        onClick={() => setShowFavorites(true)}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105 relative"
                                        title={window.languageManager.t('favorites.title')}
                                    >
                                        <span style={{fontSize: '24px'}}>‚ù§Ô∏è</span>
                                        {favoriteMessages.length > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                {favoriteMessages.length}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => {
                                            soundManager.playSleighBells();
                                            setShowReindeerPanel(true);
                                        }}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105 relative"
                                        title={window.languageManager.t('tooltip.reindeerStatus')}
                                    >
                                        <span className="text-xl">ü¶å</span>
                                        <span className="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                            {teamStatus.morale || 95}
                                        </span>
                                    </button>
                                    <button
                                        onClick={() => {
                                            soundManager.playNotification();
                                            setShowWeatherPanel(true);
                                        }}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105 relative"
                                        title={window.languageManager.t('tooltip.weatherReport', {description: currentWeather?.description || window.languageManager.t('general.loading')})}
                                    >
                                        <span className="text-xl">
                                            {currentWeather?.icon || 'üå§Ô∏è'}
                                        </span>
                                        {currentWeather?.christmasMagic && (
                                            <span className="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                ‚ú®
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => {
                                            soundManager.playNotification();
                                            setShowSafetyPanel(true);
                                        }}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105 relative"
                                        title={window.languageManager.t('tooltip.safetyTips', {title: currentSafetyTip?.title || window.languageManager.t('general.loading')})}
                                    >
                                        <span style={{fontSize: '24px'}}>üõ°Ô∏è</span>
                                        {currentSafetyTip?.severity === 'critical' && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                !
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setShowConfigPanel(true)}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105"
                                        title={window.languageManager.t('tooltip.openConfig')}
                                    >
                                        <span style={{fontSize: '24px'}}>‚öôÔ∏è</span>
                                    </button>
                                    <button
                                        onClick={() => setShowNaughtyListManager(true)}
                                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all transform hover:scale-105 relative"
                                        title={window.languageManager.t('tooltip.manageNaughtyList')}
                                    >
                                        <span style={{fontSize: '24px'}}>üìã</span>
                                        {customNaughtyList.length > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                {customNaughtyList.length}
                                            </span>
                                        )}
                                    </button>
                                </div>
                            </div>
                            <p className="text-blue-200 text-xl">{window.languageManager.t('app.subtitle')}</p>
                        </div>

                        {/* Santa's Sleigh Illustration */}
                        <div className="bg-gradient-to-b from-blue-800 to-blue-900 rounded-3xl p-8 mb-6 relative overflow-hidden shadow-2xl">
                            <div className="absolute top-0 left-0 w-full h-full">
                                {/* Stars */}
                                {[...Array(50)].map((_, i) => (
                                    <div
                                        key={i}
                                        className="absolute bg-white rounded-full"
                                        style={{
                                            width: Math.random() * 3 + 1 + 'px',
                                            height: Math.random() * 3 + 1 + 'px',
                                            top: Math.random() * 100 + '%',
                                            left: Math.random() * 100 + '%',
                                            opacity: Math.random() * 0.7 + 0.3,
                                            animation: `twinkle ${Math.random() * 3 + 2}s infinite`
                                        }}
                                    />
                                ))}
                            </div>

                            {/* Moon */}
                            <div className="absolute top-8 right-8 w-24 h-24 bg-yellow-100 rounded-full shadow-lg opacity-80" />

                            {/* Santa and Sleigh */}
                            <div className="relative z-10 text-center py-12">
                                <div className="text-9xl mb-4 animate-bounce">
                                    üéÖ
                                </div>
                                <div className="text-6xl -mt-8 mb-4">
                                    ü¶åü¶åü¶å
                                </div>
                                <div className="text-5xl -mt-6">
                                    üõ∑
                                </div>
                            </div>
                        </div>

                        {/* Location Permission */}
                        {locationPermission === 'prompt' && (
                            <div className="bg-white rounded-2xl p-8 mb-6 shadow-xl text-center">
                                <span style={{fontSize: '64px', color: '#dc2626', display: 'block', textAlign: 'center', marginBottom: '16px'}}>üìç</span>
                                <h2 className="text-2xl font-bold mb-4 text-gray-800">
                                    {window.languageManager.t('location.promptTitle')}
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    {window.languageManager.t('location.promptDescription')}
                                </p>
                                <button
                                    onClick={requestLocation}
                                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-full text-lg transition-all transform hover:scale-105 shadow-lg"
                                >
                                    {window.languageManager.t('button.shareLocation')}
                                </button>
                            </div>
                        )}

                        {locationPermission === 'denied' && (
                            <div className="bg-yellow-50 border-2 border-yellow-400 rounded-2xl p-6 mb-6">
                                <p className="text-yellow-800 text-center">
                                    {window.languageManager.t('location.deniedMessage')}
                                </p>
                            </div>
                        )}

                        {/* Santa Stats */}
                        {santaStats && (
                            <div className="bg-white rounded-2xl p-8 shadow-xl mb-6">
                                <div className="grid md:grid-cols-2 gap-6 mb-6">
                                    <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white">
                                        <div className="flex items-center mb-2">
                                            <span style={{fontSize: '24px', marginRight: '8px'}}>üïê</span>
                                            <h3 className="text-lg font-semibold">{window.languageManager.t('stats.status')}</h3>
                                        </div>
                                        <p className="text-3xl font-bold">{santaStats.status}</p>
                                    </div>

                                    {santaStats.distance !== undefined && (
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
                                            <div className="flex items-center mb-2">
                                                <span style={{fontSize: '24px', marginRight: '8px'}}>üìç</span>
                                                <h3 className="text-lg font-semibold">{window.languageManager.t('stats.distance')}</h3>
                                            </div>
                                            <p className="text-3xl font-bold">
                                                {santaStats.distance.toLocaleString()} km
                                            </p>
                                            <p className="text-sm opacity-90">{window.languageManager.t('stats.fromYourLocation')}</p>
                                        </div>
                                    )}

                                    {santaStats.giftsDelivered > 0 && (
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                                            <div className="flex items-center mb-2">
                                                <span style={{fontSize: '24px', marginRight: '8px'}}>üéÅ</span>
                                                <h3 className="text-lg font-semibold">{window.languageManager.t('stats.giftsDelivered')}</h3>
                                            </div>
                                            <p className="text-3xl font-bold">
                                                {santaStats.giftsDelivered.toLocaleString()}
                                            </p>
                                        </div>
                                    )}

                                    {santaStats.timeUntil !== undefined && santaStats.timeUntil > 0 && (
                                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                                            <div className="flex items-center mb-2">
                                                <span style={{fontSize: '24px', marginRight: '8px'}}>üïê</span>
                                                <h3 className="text-lg font-semibold">{window.languageManager.t('stats.timeUntilArrival')}</h3>
                                            </div>
                                            <p className="text-3xl font-bold">
                                                {santaStats.timeUntil} {santaStats.timeUntil !== 1 ? window.languageManager.t('stats.hoursPlural') : window.languageManager.t('stats.hours')}
                                            </p>
                                        </div>
                                    )}
                                </div>

                                {/* Show on Map Button */}
                                <div className="text-center mb-4">
                                    <button
                                        onClick={() => setShowSantaMap(true)}
                                        className="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-all transform hover:scale-105 shadow-lg"
                                    >
                                        üó∫Ô∏è {window.languageManager.t('button.showOnMap') || 'Show Santa on Map'}
                                    </button>
                                </div>

                                {userLocation && (
                                    <div className="bg-blue-50 rounded-xl p-4 text-center">
                                        <p className="text-gray-700">
                                            üìç {window.languageManager.t('location.yourLocation')}: {userLocationName || `${userLocation.lat.toFixed(2)}¬∞, ${userLocation.lon.toFixed(2)}¬∞`}
                                        </p>
                                        <p className="text-gray-600 text-sm mt-1">
                                            {window.languageManager.t('location.tracking')}
                                        </p>
                                    </div>
                                )}

                                {/* Weather Report */}
                                {currentWeather && (
                                    <div className="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl p-4 mt-4 border border-cyan-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <h4 className="font-semibold text-cyan-800 flex items-center">
                                                <span className="text-lg mr-2">{currentWeather.icon}</span>
                                                {window.languageManager.t('weather.title')}
                                            </h4>
                                            <button
                                                onClick={() => setShowWeatherPanel(true)}
                                                className="text-cyan-600 hover:text-cyan-800 text-sm font-medium"
                                            >
                                                {window.languageManager.t('weather.viewDetails')}
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                            <div className="text-center">
                                                <p className="text-gray-600">{window.languageManager.t('weather.location')}</p>
                                                <p className="font-medium">{currentWeather.location.area}</p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-gray-600">{window.languageManager.t('weather.condition')}</p>
                                                <p className="font-medium">{currentWeather.description}</p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-gray-600">{window.languageManager.t('weather.temperature')}</p>
                                                <p className="font-medium">{Math.round(currentWeather.temperature)}¬∞C</p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-gray-600">{window.languageManager.t('weather.flightStatus')}</p>
                                                <p className={`font-medium capitalize ${
                                                    currentWeather.difficulty === 'easy' ? 'text-green-600' :
                                                    currentWeather.difficulty === 'moderate' ? 'text-yellow-600' :
                                                    'text-red-600'
                                                }`}>
                                                    {currentWeather.difficulty}
                                                </p>
                                            </div>
                                        </div>
                                        {currentWeather.christmasMagic && (
                                            <div className="mt-3 text-center">
                                                <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    ‚ú® {window.languageManager.t('weather.christmasMagicActive')} ‚ú®
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Safety Tip Display */}
                        {currentSafetyTip && (
                            <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl p-6 shadow-xl mb-6 border-2 border-orange-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-xl font-bold text-orange-800 flex items-center">
                                        <span className="text-2xl mr-3">{currentSafetyTip.icon}</span>
                                        {window.languageManager.t('safety.title')}
                                    </h3>
                                    <div className="flex items-center space-x-2">
                                        <span className={`px-3 py-1 rounded-full text-xs font-medium border ${
                                            currentSafetyTip.severity === 'critical' ? 'bg-red-100 text-red-800 border-red-300' :
                                            currentSafetyTip.severity === 'important' ? 'bg-yellow-100 text-yellow-800 border-yellow-300' :
                                            'bg-blue-100 text-blue-800 border-blue-300'
                                        }`}>
                                            {currentSafetyTip.severity === 'critical' ? 'üö®' :
                                             currentSafetyTip.severity === 'important' ? '‚ö†Ô∏è' : 'üí°'} {window.languageManager.t(`safety.severity.${currentSafetyTip.severity}`)}
                                        </span>
                                        <button
                                            onClick={() => setShowSafetyPanel(true)}
                                            className="text-orange-600 hover:text-orange-800 text-sm font-medium"
                                        >
                                            {window.languageManager.t('safety.viewAllTips')}
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white bg-opacity-70 rounded-xl p-4 mb-4">
                                    <h4 className="font-semibold text-gray-800 mb-2">{currentSafetyTip.title}</h4>
                                    <p className="text-gray-700 mb-3">{currentSafetyTip.tip}</p>
                                    <div className="bg-gradient-to-r from-red-50 to-green-50 rounded-lg p-3 border border-red-200">
                                        <p className="text-red-700 text-sm italic font-medium">
                                            üéÖ "{currentSafetyTip.santaQuote}"
                                        </p>
                                    </div>
                                </div>
                                <div className="text-center">
                                    <p className="text-xs text-orange-600">
                                        {window.languageManager.t('safety.tipRotationMessage')} üõ°Ô∏è
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* Santa's Personal Message */}
                        {santaStats && (
                            <div className="bg-gradient-to-br from-red-50 to-green-50 rounded-2xl p-8 shadow-xl mb-6 border-2 border-red-200">
                                <div className="text-center mb-4">
                                    <h2 className="text-2xl font-bold text-red-700 mb-2">
                                        üéÖ {window.languageManager.t('santaMessage.title')}
                                    </h2>
                                    <p className="text-sm text-gray-600 mb-3">
                                        {window.languageManager.t('santaMessage.subtitle')}
                                    </p>
                                    <div className="flex flex-col sm:flex-row gap-3 justify-center">
                                        <button
                                            onClick={getSantaMessage}
                                            disabled={loadingMessage}
                                            className="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-6 rounded-full transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {loadingMessage
                                                ? window.languageManager.t('ai.generating')
                                                : window.languageManager.t('button.getSantaMessage')
                                            }
                                        </button>

                                        {userLocation && (
                                            <button
                                                onClick={() => createUserLocationGiftDrop()}
                                                className="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-full transition-all transform hover:scale-105 shadow-lg"
                                            >
                                                üéØ {window.languageManager.t('button.specialDelivery') || 'Special Delivery'}
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {santaMessage && (
                                    <div className="bg-white rounded-xl p-6 shadow-inner mt-4 border-2 border-green-200">
                                        <div className="flex justify-between items-start mb-3">
                                            <p className="text-gray-800 text-lg leading-relaxed italic flex-1">
                                                "{santaMessage}"
                                            </p>
                                            <div className="flex space-x-2 ml-4">
                                                <button
                                                    onClick={() => {
                                                        if (isMessageFavorited(santaMessage)) {
                                                            const favorite = favoriteMessages.find(fav => fav.message === santaMessage);
                                                            if (favorite) removeFromFavorites(favorite.id);
                                                        } else {
                                                            addToFavorites(santaMessage);
                                                        }
                                                    }}
                                                    className={`p-2 rounded-full transition-all transform hover:scale-110 ${
                                                        isMessageFavorited(santaMessage)
                                                            ? 'text-red-500 bg-red-50 hover:bg-red-100'
                                                            : 'text-gray-400 hover:text-red-500 hover:bg-red-50'
                                                    }`}
                                                    title={isMessageFavorited(santaMessage) ? window.languageManager.t('favorites.removeFromFavorites') : window.languageManager.t('favorites.addToFavorites')}
                                                >
                                                    <span style={{fontSize: '20px'}}>
                                                        {isMessageFavorited(santaMessage) ? '‚ù§Ô∏è' : 'ü§ç'}
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-right text-red-600 font-bold">
                                            - Santa Claus üéÖ
                                        </p>
                                    </div>
                                )}

                            </div>
                        )}

                        {/* Footer */}
                        <div className="text-center mt-8 text-blue-200">
                            <p className="text-sm">
                                üéÑ {window.languageManager.t('footer.currentTime')}: {currentTime.toLocaleTimeString()} üéÑ
                            </p>
                            <p className="text-xs mt-2 opacity-75">
                                {window.languageManager.t('footer.journeyMessage')}
                            </p>
                            <p className="text-xs mt-1 text-green-300">
                                üéÑ {window.languageManager.t('footer.systemsOperational')} üéÑ
                            </p>
                        </div>
                    </div>

                    {/* Enhanced Animated Gift Drops */}
                    {gifts.map(gift => {
                        const getGiftClassName = (type) => {
                            switch (type) {
                                case 'special':
                                    return 'gift-drop special magical-shimmer';
                                case 'user-targeted':
                                    return 'gift-drop user-targeted magical-shimmer';
                                case 'location-target':
                                    return 'gift-location-target';
                                case 'sparkle':
                                    return 'gift-sparkle';
                                case 'trail':
                                    return 'gift-trail';
                                default:
                                    return 'gift-drop';
                            }
                        };

                        return (
                            <div
                                key={gift.id}
                                className={getGiftClassName(gift.type)}
                                style={{
                                    left: `${gift.x}px`,
                                    top: gift.type === 'sparkle' ? `${Math.random() * 200 + 100}px` :
                                         gift.type === 'trail' ? '20vh' : '-100px',
                                    animationDelay: `${gift.delay || 0}ms`,
                                    transform: gift.rotation ? `rotate(${gift.rotation}deg)` : 'none'
                                }}
                            >
                                {gift.emoji}
                            </div>
                        );
                    })}

                    {/* Simple Configuration Panel */}
                    <SimpleConfigPanel
                        isVisible={showConfigPanel}
                        onClose={setShowConfigPanel}
                        currentModel={currentModel}
                        availableModels={availableModels}
                        onModelChange={handleModelChange}
                    />

                    {/* Nice List Checker */}
                    <NiceListChecker
                        isVisible={showNiceListChecker}
                        onClose={setShowNiceListChecker}
                        niceListName={niceListName}
                        setNiceListName={setNiceListName}
                        niceListResult={niceListResult}
                        checkingNiceList={checkingNiceList}
                        onCheck={checkNiceList}
                    />

                    {/* Language Selector */}
                    <LanguageSelector
                        isVisible={showLanguageSelector}
                        onClose={setShowLanguageSelector}
                        currentLanguage={currentLanguage}
                        onLanguageChange={handleLanguageChange}
                    />

                    {/* Favorites Manager */}
                    <FavoritesManager
                        isVisible={showFavorites}
                        onClose={setShowFavorites}
                        favorites={favoriteMessages}
                        onRemove={removeFromFavorites}
                        currentLanguage={currentLanguage}
                    />

                    {/* Reindeer Panel */}
                    <ReindeerPanel
                        isVisible={showReindeerPanel}
                        onClose={setShowReindeerPanel}
                        reindeerTeam={reindeerTeam}
                        teamStatus={teamStatus}
                    />

                    {/* Weather Panel */}
                    <WeatherPanel
                        isVisible={showWeatherPanel}
                        onClose={setShowWeatherPanel}
                        currentWeather={currentWeather}
                        weatherHistory={weatherHistory}
                        weatherForecast={weatherForecast}
                    />

                    {/* Chimney Safety Panel */}
                    <ChimneySafetyPanel
                        isVisible={showSafetyPanel}
                        onClose={setShowSafetyPanel}
                        currentTip={currentSafetyTip}
                        allTips={allSafetyTips}
                        categories={safetyCategories}
                    />

                    {/* Naughty List Manager */}
                    <NaughtyListManager
                        isVisible={showNaughtyListManager}
                        onClose={setShowNaughtyListManager}
                        naughtyList={customNaughtyList}
                        onAdd={addToNaughtyList}
                        onRemove={removeFromNaughtyList}
                        currentLanguage={currentLanguage}
                        newName={newNaughtyName}
                        setNewName={setNewNaughtyName}
                    />

                    {/* Santa Map Modal */}
                    <SantaMapModal
                        isVisible={showSantaMap}
                        onClose={setShowSantaMap}
                        santaStats={santaStats}
                        userLocation={userLocation}
                    />

                </div>
            );
        }

        try {
            console.log('üéÖ Starting Santa Tracker Enhanced...');

            // Debug mode instructions
            if (window.location.hash.includes('debug')) {
                console.log('üöß DEBUG MODE ACTIVE: Korean validation bypassed');
                console.log('üí° To disable debug mode, remove #debug from URL');
            } else {
                console.log('üí° To enable debug mode (bypass Korean validation), add #debug to URL');
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<SantaTrackerEnhanced />);
            console.log('‚úÖ Santa Tracker Enhanced mounted successfully!');
        } catch (error) {
            console.error('‚ùå Failed to mount Santa Tracker:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 40px; color: red; text-align: center; font-family: Arial;">
                    <h1>üéÖ Santa Tracker Error</h1>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Check browser console for details.</p>
                    <pre style="text-align: left; background: #f5f5f5; padding: 10px; border-radius: 5px;">
${error.stack}
                    </pre>
                </div>
            `;
        }
    </script>
</body>
</html>